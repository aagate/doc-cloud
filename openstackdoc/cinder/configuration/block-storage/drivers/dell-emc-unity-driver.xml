<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/cinder/doc/source/configuration/block-storage/drivers/dell-emc-unity-driver.rst">
    <section ids="dell-emc-unity-driver" names="dell\ emc\ unity\ driver">
        <title>Dell EMC Unity driver</title>
        <paragraph>Unity driver has been integrated in the OpenStack Block Storage project since
            the Ocata release. The driver is built on the top of Block Storage framework
            and a Dell EMC distributed Python package
            <reference name="storops" refuri="https://pypi.python.org/pypi/storops">storops</reference><target ids="storops" names="storops" refuri="https://pypi.python.org/pypi/storops"></target>.</paragraph>
        <section ids="prerequisites" names="prerequisites">
            <title>Prerequisites</title>
            <table>
                <tgroup cols="2">
                    <colspec colwidth="19"></colspec>
                    <colspec colwidth="16"></colspec>
                    <thead>
                        <row>
                            <entry>
                                <paragraph>Software</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Version</paragraph>
                            </entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <paragraph>Unity OE</paragraph>
                            </entry>
                            <entry>
                                <paragraph>4.1.X</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph>OpenStack</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Ocata</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph>storops</paragraph>
                            </entry>
                            <entry>
                                <paragraph>0.4.2 or newer</paragraph>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section ids="supported-operations" names="supported\ operations">
            <title>Supported operations</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Create, delete, attach, and detach volumes.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create, list, and delete volume snapshots.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create a volume from a snapshot.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Copy an image to a volume.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create an image from a volume.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Clone a volume.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Extend a volume.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Migrate a volume.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Get volume statistics.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Efficient non-disruptive volume backup.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="driver-configuration" names="driver\ configuration">
            <title>Driver configuration</title>
            <note>
                <paragraph>The following instructions should all be performed on Black Storage
                    nodes.</paragraph>
            </note>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Install <title_reference>storops</title_reference> from pypi:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># pip install storops</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Add the following content into <literal>/etc/cinder/cinder.conf</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
enabled_backends = unity

[unity]
# Storage protocol
storage_protocol = iSCSI
# Unisphere IP
san_ip = &lt;SAN IP&gt;
# Unisphere username and password
san_login = &lt;SAN LOGIN&gt;
san_password = &lt;SAN PASSWORD&gt;
# Volume driver name
volume_driver = cinder.volume.drivers.dell_emc.unity.Driver
# backend's name
volume_backend_name = Storage_ISCSI_01</literal_block>
                    <note>
                        <paragraph>These are minimal options for Unity driver, for more options,
                            see <reference name="Driver options" refid="driver-options">Driver options</reference>.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
            <note>
                <paragraph>(<strong>Optional</strong>) If you require multipath based data access, perform
                    below steps on both Block Storage and Compute nodes.</paragraph>
            </note>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Install <literal>sysfsutils</literal>, <literal>sg3-utils</literal> and <literal>multipath-tools</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># apt-get install multipath-tools sg3-utils sysfsutils</literal_block>
                </list_item>
                <list_item>
                    <paragraph>(Required for FC driver in case <reference name="Auto-zoning Support" refid="auto-zoning-support">Auto-zoning Support</reference> is disabled) Zone the
                        FC ports of Compute nodes with Unity FC target ports.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Enable Unity storage optimized multipath configuration:</paragraph>
                    <paragraph>Add the following content into <literal>/etc/multipath.conf</literal></paragraph>
                    <literal_block highlight_args="{}" language="vim" linenos="False" xml:space="preserve">blacklist {
    # Skip the files uner /dev that are definitely not FC/iSCSI devices
    # Different system may need different customization
    devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
    devnode "^hd[a-z][0-9]*"
    devnode "^cciss!c[0-9]d[0-9]*[p[0-9]*]"

    # Skip LUNZ device from VNX/Unity
    device {
        vendor "DGC"
        product "LUNZ"
    }
}

defaults {
    user_friendly_names no
    flush_on_last_del yes
}

devices {
    # Device attributed for EMC CLARiiON and VNX/Unity series ALUA
    device {
        vendor "DGC"
        product ".*"
        product_blacklist "LUNZ"
        path_grouping_policy group_by_prio
        path_selector "round-robin 0"
        path_checker emc_clariion
        features "0"
        no_path_retry 12
        hardware_handler "1 alua"
        prio alua
        failback immediate
    }
}</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Restart the multipath service:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># service multipath-tools restart</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Enable multipath for image transfer in <literal>/etc/cinder/cinder.conf</literal>.</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">use_multipath_for_image_xfer = True</literal_block>
                    <paragraph>Restart the <literal>cinder-volume</literal> service to load the change.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Enable multipath for volume attache/detach in <literal>/etc/nova/nova.conf</literal>.</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[libvirt]
...
volume_use_multipath = True
...</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Restart the <literal>nova-compute</literal> service.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="driver-options" names="driver\ options">
            <title>Driver options</title>
            <comment xml:space="preserve">Warning: Do not edit this file. It is automatically generated from the
software project's code and your changes will be overwritten.

The tool to generate this file lives in openstack-doc-tools repository.

Please make any changes needed in the code, then run the
autogenerate-config-doc tool from the openstack-doc-tools repository, or
ask for help on the documentation mailing list, IRC channel or meeting.</comment>
            <target refid="cinder-dell-emc-unity"></target>
            <table classes="config-ref-table" ids="id1 cinder-dell-emc-unity" names="cinder-dell_emc_unity">
                <title>Description of Dell EMC Unity volume driver configuration options</title>
                <tgroup cols="2">
                    <colspec colwidth="50"></colspec>
                    <colspec colwidth="50"></colspec>
                    <thead>
                        <row>
                            <entry>
                                <paragraph>Configuration option = Default value</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Description</paragraph>
                            </entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <paragraph><strong>[DEFAULT]</strong></paragraph>
                            </entry>
                            <entry>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph><literal>unity_io_ports</literal> = <literal>None</literal></paragraph>
                            </entry>
                            <entry>
                                <paragraph>(List) A comma-separated list of iSCSI or FC ports to be used. Each port can be Unix-style glob expressions.</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph><literal>unity_storage_pool_names</literal> = <literal>None</literal></paragraph>
                            </entry>
                            <entry>
                                <paragraph>(List) A comma-separated list of storage pool names to be used.</paragraph>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <section ids="fc-or-iscsi-ports-option" names="fc\ or\ iscsi\ ports\ option">
                <title>FC or iSCSI ports option</title>
                <paragraph>Specify the list of FC or iSCSI ports to be used to perform the IO. Wild card
                    character is supported.
                    For iSCSI ports, use the following format:</paragraph>
                <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">unity_io_ports = spa_eth2, spb_eth2, *_eth3</literal_block>
                <paragraph>For FC ports, use the following format:</paragraph>
                <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">unity_io_ports = spa_iom_0_fc0, spb_iom_0_fc0, *_iom_0_fc1</literal_block>
                <paragraph>List the port ID with the <literal_strong classes="command">uemcli</literal_strong> command:</paragraph>
                <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ uemcli /net/port/eth show -output csv
...
"spa_eth2","SP A Ethernet Port 2","spa","file, net, iscsi", ...
"spb_eth2","SP B Ethernet Port 2","spb","file, net, iscsi", ...
...

$ uemcli /net/port/fc show -output csv
...
"spa_iom_0_fc0","SP A I/O Module 0 FC Port 0","spa", ...
"spb_iom_0_fc0","SP B I/O Module 0 FC Port 0","spb", ...
...</literal_block>
            </section>
        </section>
        <section ids="live-migration-integration" names="live\ migration\ integration">
            <title>Live migration integration</title>
            <paragraph>It is suggested to have multipath configured on Compute nodes for robust data
                access in VM instances live migration scenario. Once <literal>user_friendly_names no</literal>
                is set in defaults section of <literal>/etc/multipath.conf</literal>, Compute nodes will use
                the WWID as the alias for the multipath devices.</paragraph>
            <paragraph>To enable multipath in live migration:</paragraph>
            <note>
                <paragraph>Make sure <reference name="Driver configuration" refid="driver-configuration">Driver configuration</reference> steps are performed before
                    following steps.</paragraph>
            </note>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Set multipath in <literal>/etc/nova/nova.conf</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[libvirt]
...
volume_use_multipath = True
...</literal_block>
                    <paragraph>Restart <title_reference>nova-compute</title_reference> service.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Set <literal>user_friendly_names no</literal> in <literal>/etc/multipath.conf</literal></paragraph>
                    <literal_block highlight_args="{}" language="text" linenos="False" xml:space="preserve">...
defaults {
    user_friendly_names no
}
...</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Restart the <literal>multipath-tools</literal> service.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="thin-and-thick-provisioning" names="thin\ and\ thick\ provisioning">
            <title>Thin and thick provisioning</title>
            <paragraph>Only thin volume provisioning is supported in Unity volume driver.</paragraph>
        </section>
        <section ids="qos-support" names="qos\ support">
            <title>QoS support</title>
            <paragraph>Unity driver supports <literal>maxBWS</literal> and <literal>maxIOPS</literal> specs for the back-end
                consumer type. <literal>maxBWS</literal> represents the <literal>Maximum IO/S</literal> absolute limit,
                <literal>maxIOPS</literal> represents the <literal>Maximum Bandwidth (KBPS)</literal> absolute limit on the
                Unity respectively.</paragraph>
        </section>
        <section ids="auto-zoning-support" names="auto-zoning\ support">
            <title>Auto-zoning support</title>
            <paragraph>Unity volume driver supports auto-zoning, and share the same configuration
                guide for other vendors. Refer to <reference internal="True" refuri="../fc-zoning#fc-zone-manager"><inline classes="std std-ref">Fibre Channel Zone Manager</inline></reference>
                for detailed configuration steps.</paragraph>
        </section>
        <section ids="solution-for-lunz-device" names="solution\ for\ lunz\ device">
            <title>Solution for LUNZ device</title>
            <paragraph>The EMC host team also found LUNZ on all of the hosts, EMC best practice is to
                present a LUN with HLU 0 to clear any LUNZ devices as they can cause issues on
                the host. See KB <reference name="LUNZ Device" refuri="https://support.emc.com/kb/463402">LUNZ Device</reference><target ids="lunz-device" names="lunz\ device" refuri="https://support.emc.com/kb/463402"></target>.</paragraph>
            <paragraph>To workaround this issue, Unity driver creates a <title_reference>Dummy LUN</title_reference> (if not present),
                and adds it to each host to occupy the <title_reference>HLU 0</title_reference> during volume attachment.</paragraph>
            <note>
                <paragraph>This <title_reference>Dummy LUN</title_reference> is shared among all hosts connected to the Unity.</paragraph>
            </note>
        </section>
        <section ids="efficient-non-disruptive-volume-backup" names="efficient\ non-disruptive\ volume\ backup">
            <title>Efficient non-disruptive volume backup</title>
            <paragraph>The default implementation in Block Storage for non-disruptive volume backup is
                not efficient since a cloned volume will be created during backup.</paragraph>
            <paragraph>An effective approach to backups is to create a snapshot for the volume and
                connect this snapshot to the Block Storage host for volume backup.</paragraph>
        </section>
        <section ids="force-detach-volume-from-all-hosts" names="force\ detach\ volume\ from\ all\ hosts">
            <title>Force detach volume from all hosts</title>
            <paragraph>The user could use <title_reference>os-force_detach</title_reference> action to detach a volume from all its
                attached hosts.
                For more detail, please refer to
                <reference refuri="https://developer.openstack.org/api-ref/block-storage/v2/?expanded=force-detach-volume-detail#force-detach-volume">https://developer.openstack.org/api-ref/block-storage/v2/?expanded=force-detach-volume-detail#force-detach-volume</reference></paragraph>
        </section>
        <section ids="troubleshooting" names="troubleshooting">
            <title>Troubleshooting</title>
            <paragraph>To troubleshoot a failure in OpenStack deployment, the best way is to
                enable verbose and debug log, at the same time, leverage the build-in
                <reference name="Return request ID to caller" refuri="https://specs.openstack.org/openstack/openstack-specs/specs/return-request-id.html">Return request ID to caller</reference><target ids="return-request-id-to-caller" names="return\ request\ id\ to\ caller" refuri="https://specs.openstack.org/openstack/openstack-specs/specs/return-request-id.html"></target>
                to track specific Block Storage command logs.</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Enable verbose log, set following in <literal>/etc/cinder/cinder.conf</literal> and restart
                        all Block Storage services:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]

...

debug = True
verbose = True

...</literal_block>
                    <paragraph>If other projects (usually Compute) are also involved, set <title_reference>debug</title_reference>
                        and <literal>verbose</literal> to <literal>True</literal>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>use <literal>--debug</literal> to trigger any problematic Block Storage operation:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># cinder --debug create --name unity_vol1 100</literal_block>
                    <paragraph>You will see the request ID from the console, for example:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">DEBUG:keystoneauth:REQ: curl -g -i -X POST
http://192.168.1.9:8776/v2/e50d22bdb5a34078a8bfe7be89324078/volumes -H
"User-Agent: python-cinderclient" -H "Content-Type: application/json" -H
"Accept: application/json" -H "X-Auth-Token:
{SHA1}bf4a85ad64302b67a39ad7c6f695a9630f39ab0e" -d '{"volume": {"status":
"creating", "user_id": null, "name": "unity_vol1", "imageRef": null,
"availability_zone": null, "description": null, "multiattach": false,
"attach_status": "detached", "volume_type": null, "metadata": {},
"consistencygroup_id": null, "source_volid": null, "snapshot_id": null,
"project_id": null, "source_replica": null, "size": 10}}'
DEBUG:keystoneauth:RESP: [202] X-Compute-Request-Id:
req-3a459e0e-871a-49f9-9796-b63cc48b5015 Content-Type: application/json
Content-Length: 804 X-Openstack-Request-Id:
req-3a459e0e-871a-49f9-9796-b63cc48b5015 Date: Mon, 12 Dec 2016 09:31:44 GMT
Connection: keep-alive</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Use commands like <literal>grep</literal>, <literal>awk</literal> to find the error related to the Block
                        Storage operations.</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># grep "req-3a459e0e-871a-49f9-9796-b63cc48b5015" cinder-volume.log</literal_block>
                </list_item>
            </enumerated_list>
        </section>
    </section>
</document>
