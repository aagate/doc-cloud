<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/cinder/doc/source/install/cinder-controller-install-ubuntu.rst">
    <section ids="install-and-configure-controller-node" names="install\ and\ configure\ controller\ node">
        <title>Install and configure controller node</title>
        <paragraph>This section describes how to install and configure the Block
            Storage service, code-named cinder, on the controller node. This
            service requires at least one additional storage node that provides
            volumes to instances.</paragraph>
        <section ids="prerequisites" names="prerequisites">
            <title>Prerequisites</title>
            <paragraph>Before you install and configure the Block Storage service, you
                must create a database, service credentials, and API endpoints.</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>To create the database, complete these steps:</paragraph>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Use the database access client to connect to the database
                                server as the <literal>root</literal> user:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># mysql</literal_block>
                        </list_item>
                        <list_item>
                            <paragraph>Create the <literal>cinder</literal> database:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">MariaDB [(none)]&gt; CREATE DATABASE cinder;</literal_block>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Grant proper access to the <literal>cinder</literal> database:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' \
  IDENTIFIED BY 'CINDER_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' \
  IDENTIFIED BY 'CINDER_DBPASS';</literal_block>
                        <paragraph>Replace <literal>CINDER_DBPASS</literal> with a suitable password.</paragraph>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Exit the database access client.</paragraph>
                        </list_item>
                    </enumerated_list>
                </list_item>
                <list_item>
                    <paragraph>Source the <literal>admin</literal> credentials to gain access to admin-only
                        CLI commands:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ . admin-openrc</literal_block>
                </list_item>
                <list_item>
                    <paragraph>To create the service credentials, complete these steps:</paragraph>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Create a <literal>cinder</literal> user:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack user create --domain default --password-prompt cinder

User Password:
Repeat User Password:
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | 9d7e33de3e1a498390353819bc7d245d |
| name                | cinder                           |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+</literal_block>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Add the <literal>admin</literal> role to the <literal>cinder</literal> user:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack role add --project service --user cinder admin</literal_block>
                        <note>
                            <paragraph>This command provides no output.</paragraph>
                        </note>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Create the <literal>cinderv2</literal> and <literal>cinderv3</literal> service entities:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack service create --name cinderv2 \
  --description "OpenStack Block Storage" volumev2

+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Block Storage          |
| enabled     | True                             |
| id          | eb9fd245bdbc414695952e93f29fe3ac |
| name        | cinderv2                         |
| type        | volumev2                         |
+-------------+----------------------------------+</literal_block>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack service create --name cinderv3 \
  --description "OpenStack Block Storage" volumev3

+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Block Storage          |
| enabled     | True                             |
| id          | ab3bbbef780845a1a283490d281e7fda |
| name        | cinderv3                         |
| type        | volumev3                         |
+-------------+----------------------------------+</literal_block>
                    </block_quote>
                    <note>
                        <paragraph>The Block Storage services require two service entities.</paragraph>
                    </note>
                </list_item>
                <list_item>
                    <paragraph>Create the Block Storage service API endpoints:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack endpoint create --region RegionOne \
  volumev2 public http://controller:8776/v2/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | 513e73819e14460fb904163f41ef3759         |
| interface    | public                                   |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |
| service_name | cinderv2                                 |
| service_type | volumev2                                 |
| url          | http://controller:8776/v2/%(project_id)s |
+--------------+------------------------------------------+

$ openstack endpoint create --region RegionOne \
  volumev2 internal http://controller:8776/v2/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | 6436a8a23d014cfdb69c586eff146a32         |
| interface    | internal                                 |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |
| service_name | cinderv2                                 |
| service_type | volumev2                                 |
| url          | http://controller:8776/v2/%(project_id)s |
+--------------+------------------------------------------+

$ openstack endpoint create --region RegionOne \
  volumev2 admin http://controller:8776/v2/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | e652cf84dd334f359ae9b045a2c91d96         |
| interface    | admin                                    |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |
| service_name | cinderv2                                 |
| service_type | volumev2                                 |
| url          | http://controller:8776/v2/%(project_id)s |
+--------------+------------------------------------------+</literal_block>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack endpoint create --region RegionOne \
  volumev3 public http://controller:8776/v3/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | 03fa2c90153546c295bf30ca86b1344b         |
| interface    | public                                   |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | ab3bbbef780845a1a283490d281e7fda         |
| service_name | cinderv3                                 |
| service_type | volumev3                                 |
| url          | http://controller:8776/v3/%(project_id)s |
+--------------+------------------------------------------+

$ openstack endpoint create --region RegionOne \
  volumev3 internal http://controller:8776/v3/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | 94f684395d1b41068c70e4ecb11364b2         |
| interface    | internal                                 |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | ab3bbbef780845a1a283490d281e7fda         |
| service_name | cinderv3                                 |
| service_type | volumev3                                 |
| url          | http://controller:8776/v3/%(project_id)s |
+--------------+------------------------------------------+

$ openstack endpoint create --region RegionOne \
  volumev3 admin http://controller:8776/v3/%\(project_id\)s

+--------------+------------------------------------------+
| Field        | Value                                    |
+--------------+------------------------------------------+
| enabled      | True                                     |
| id           | 4511c28a0f9840c78bacb25f10f62c98         |
| interface    | admin                                    |
| region       | RegionOne                                |
| region_id    | RegionOne                                |
| service_id   | ab3bbbef780845a1a283490d281e7fda         |
| service_name | cinderv3                                 |
| service_type | volumev3                                 |
| url          | http://controller:8776/v3/%(project_id)s |
+--------------+------------------------------------------+</literal_block>
                    <note>
                        <paragraph>The Block Storage services require endpoints for each service
                            entity.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="install-and-configure-components" names="install\ and\ configure\ components">
            <title>Install and configure components</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Install the packages:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># apt install cinder-api cinder-scheduler</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Edit the <literal>/etc/cinder/cinder.conf</literal> file and complete the
                        following actions:</paragraph>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>In the <literal>[database]</literal> section, configure database access:</paragraph>
                            <comment xml:space="preserve">path /etc/cinder/cinder.conf</comment>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[database]
# ...
connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</literal_block>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <paragraph>Replace <literal>CINDER_DBPASS</literal> with the password you chose for the
                            Block Storage database.</paragraph>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> section, configure <literal>RabbitMQ</literal>
                                message queue access:</paragraph>
                        </list_item>
                    </enumerated_list>
                    <block_quote>
                        <comment xml:space="preserve">path /etc/cinder/cinder.conf</comment>
                        <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
# ...
transport_url = rabbit://openstack:RABBIT_PASS@controller</literal_block>
                        <paragraph>Replace <literal>RABBIT_PASS</literal> with the password you chose for the
                            <literal>openstack</literal> account in <literal>RabbitMQ</literal>.</paragraph>
                    </block_quote>
                    <enumerated_list enumtype="arabic" prefix="" suffix=".">
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> and <literal>[keystone_authtoken]</literal> sections,
                                configure Identity service access:</paragraph>
                            <comment xml:space="preserve">path /etc/cinder/cinder.conf</comment>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
# ...
auth_strategy = keystone

[keystone_authtoken]
# ...
auth_uri = http://controller:5000
auth_url = http://controller:35357
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = cinder
password = CINDER_PASS</literal_block>
                            <paragraph>Replace <literal>CINDER_PASS</literal> with the password you chose for
                                the <literal>cinder</literal> user in the Identity service.</paragraph>
                            <note>
                                <paragraph>Comment out or remove any other options in the
                                    <literal>[keystone_authtoken]</literal> section.</paragraph>
                            </note>
                        </list_item>
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> section, configure the <literal>my_ip</literal> option to
                                use the management interface IP address of the controller node:</paragraph>
                            <comment xml:space="preserve">path /etc/cinder/cinder.conf</comment>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
# ...
my_ip = 10.0.0.11</literal_block>
                        </list_item>
                    </enumerated_list>
                </list_item>
                <list_item>
                    <paragraph>In the <literal>[oslo_concurrency]</literal> section, configure the lock path:</paragraph>
                    <comment xml:space="preserve">path /etc/cinder/cinder.conf</comment>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[oslo_concurrency]
# ...
lock_path = /var/lib/cinder/tmp</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Populate the Block Storage database:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># su -s /bin/sh -c "cinder-manage db sync" cinder</literal_block>
                    <note>
                        <paragraph>Ignore any deprecation messages in this output.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="configure-compute-to-use-block-storage" names="configure\ compute\ to\ use\ block\ storage">
            <title>Configure Compute to use Block Storage</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Edit the <literal>/etc/nova/nova.conf</literal> file and add the following
                        to it:</paragraph>
                    <comment xml:space="preserve">path /etc/nova/nova.conf</comment>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[cinder]
os_region_name = RegionOne</literal_block>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="finalize-installation" names="finalize\ installation">
            <title>Finalize installation</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Restart the Compute API service:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># service nova-api restart</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Restart the Block Storage services:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># service cinder-scheduler restart
# service apache2 restart</literal_block>
                </list_item>
            </enumerated_list>
        </section>
    </section>
</document>
