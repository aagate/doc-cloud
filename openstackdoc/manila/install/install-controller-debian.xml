<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/manila/doc/source/install/install-controller-debian.rst">
    <target refid="manila-controller-debian"></target>
    <section ids="install-and-configure-controller-node-on-debian manila-controller-debian" names="install\ and\ configure\ controller\ node\ on\ debian manila-controller-debian">
        <title>Install and configure controller node on Debian</title>
        <paragraph>This section describes how to install and configure the Shared File Systems
            service, code-named manila, on the controller node that runs a Debian
            distribution. This service requires at least one additional share node that
            manages file storage back ends.</paragraph>
        <section ids="prerequisites" names="prerequisites">
            <title>Prerequisites</title>
            <paragraph>Before you install and configure the Shared File Systems service, you
                must create a database, service credentials, and <title_reference>API endpoints</title_reference>.</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>To create the database, complete these steps:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>Use the database access client to connect to the database server as the
                                <literal>root</literal> user:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ mysql -u root -p</literal_block>
                        </list_item>
                        <list_item>
                            <paragraph>Create the <title_reference>manila</title_reference> database:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">CREATE DATABASE manila;</literal_block>
                        </list_item>
                        <list_item>
                            <paragraph>Grant proper access to the <literal>manila</literal> database:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">GRANT ALL PRIVILEGES ON manila.* TO 'manila'@'localhost' \
  IDENTIFIED BY 'MANILA_DBPASS';
GRANT ALL PRIVILEGES ON manila.* TO 'manila'@'%' \
  IDENTIFIED BY 'MANILA_DBPASS';</literal_block>
                            <paragraph>Replace <literal>MANILA_DBPASS</literal> with a suitable password.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>Exit the database access client.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Source the <literal>admin</literal> credentials to gain access to admin CLI commands:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ . admin-openrc.sh</literal_block>
                </list_item>
                <list_item>
                    <paragraph>To create the service credentials, complete these steps:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>Create a <literal>manila</literal> user:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack user create --domain default --password-prompt manila
User Password:
Repeat User Password:
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | e0353a670a9e496da891347c589539e9 |
| enabled   | True                             |
| id        | 83a3990fc2144100ba0e2e23886d8acc |
| name      | manila                           |
+-----------+----------------------------------+</literal_block>
                        </list_item>
                        <list_item>
                            <paragraph>Add the <literal>admin</literal> role to the <literal>manila</literal> user:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack role add --project service --user manila admin</literal_block>
                            <note>
                                <paragraph>This command provides no output.</paragraph>
                            </note>
                        </list_item>
                        <list_item>
                            <paragraph>Create the <literal>manila</literal> and <literal>manilav2</literal> service entities:</paragraph>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack service create --name manila \
  --description "OpenStack Shared File Systems" share
  +-------------+----------------------------------+
  | Field       | Value                            |
  +-------------+----------------------------------+
  | description | OpenStack Shared File Systems    |
  | enabled     | True                             |
  | id          | 82378b5a16b340aa9cc790cdd46a03ba |
  | name        | manila                           |
  | type        | share                            |
  +-------------+----------------------------------+</literal_block>
                            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack service create --name manilav2 \
  --description "OpenStack Shared File Systems" sharev2
  +-------------+----------------------------------+
  | Field       | Value                            |
  +-------------+----------------------------------+
  | description | OpenStack Shared File Systems    |
  | enabled     | True                             |
  | id          | 30d92a97a81a4e5d8fd97a32bafd7b88 |
  | name        | manilav2                         |
  | type        | sharev2                          |
  +-------------+----------------------------------+</literal_block>
                            <note>
                                <paragraph>The Shared File Systems services require two service entities.</paragraph>
                            </note>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Create the Shared File Systems service API endpoints:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack endpoint create --region RegionOne \
  share public http://controller:8786/v1/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | 0bd2bbf8d28b433aaea56a254c69f69d        |
  | interface    | public                                  |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 82378b5a16b340aa9cc790cdd46a03ba        |
  | service_name | manila                                  |
  | service_type | share                                   |
  | url          | http://controller:8786/v1/%(tenant_id)s |
  +--------------+-----------------------------------------+

$ openstack endpoint create --region RegionOne \
  share internal http://controller:8786/v1/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | a2859b5732cc48b5b083dd36dafb6fd9        |
  | interface    | internal                                |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 82378b5a16b340aa9cc790cdd46a03ba        |
  | service_name | manila                                  |
  | service_type | share                                   |
  | url          | http://controller:8786/v1/%(tenant_id)s |
  +--------------+-----------------------------------------+

$ openstack endpoint create --region RegionOne \
  share admin http://controller:8786/v1/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | f7f46df93a374cc49c0121bef41da03c        |
  | interface    | admin                                   |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 82378b5a16b340aa9cc790cdd46a03ba        |
  | service_name | manila                                  |
  | service_type | share                                   |
  | url          | http://controller:8786/v1/%(tenant_id)s |
  +--------------+-----------------------------------------+</literal_block>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack endpoint create --region RegionOne \
  sharev2 public http://controller:8786/v2/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | d63cc0d358da4ea680178657291eddc1        |
  | interface    | public                                  |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 30d92a97a81a4e5d8fd97a32bafd7b88        |
  | service_name | manilav2                                |
  | service_type | sharev2                                 |
  | url          | http://controller:8786/v2/%(tenant_id)s |
  +--------------+-----------------------------------------+

$ openstack endpoint create --region RegionOne \
  sharev2 internal http://controller:8786/v2/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | afc86e5f50804008add349dba605da54        |
  | interface    | internal                                |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 30d92a97a81a4e5d8fd97a32bafd7b88        |
  | service_name | manilav2                                |
  | service_type | sharev2                                 |
  | url          | http://controller:8786/v2/%(tenant_id)s |
  +--------------+-----------------------------------------+

$ openstack endpoint create --region RegionOne \
  sharev2 admin http://controller:8786/v2/%\(tenant_id\)s
  +--------------+-----------------------------------------+
  | Field        | Value                                   |
  +--------------+-----------------------------------------+
  | enabled      | True                                    |
  | id           | e814a0cec40546e98cf0c25a82498483        |
  | interface    | admin                                   |
  | region       | RegionOne                               |
  | region_id    | RegionOne                               |
  | service_id   | 30d92a97a81a4e5d8fd97a32bafd7b88        |
  | service_name | manilav2                                |
  | service_type | sharev2                                 |
  | url          | http://controller:8786/v2/%(tenant_id)s |
  +--------------+-----------------------------------------+</literal_block>
                    <note>
                        <paragraph>The Shared File Systems services require endpoints for each service
                            entity.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="install-and-configure-components" names="install\ and\ configure\ components">
            <title>Install and configure components</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Install the packages:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># apt-get install manila-api manila-scheduler python-manilaclient</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Edit the <literal>/etc/manila/manila.conf</literal> file and complete the following
                        actions:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>In the <literal>[database]</literal> section, configure database access:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[database]
...
connection = mysql+pymysql://manila:MANILA_DBPASS@controller/manila</literal_block>
                            <paragraph>Replace <literal>MANILA_DBPASS</literal> with the password you chose for the Shared
                                File Systems database.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
            </enumerated_list>
            <enumerated_list enumtype="arabic" prefix="" start="3" suffix=".">
                <list_item>
                    <paragraph>Complete the rest of the configuration in <literal>manila.conf</literal>:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> section, configure <literal>RabbitMQ</literal>
                                message queue access:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
...
transport_url = rabbit://openstack:RABBIT_PASS@controller</literal_block>
                            <paragraph>Replace <literal>RABBIT_PASS</literal> with the  password you chose for the <literal>openstack</literal>
                                account in <literal>RabbitMQ</literal>.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> section, set the following config values:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
...
default_share_type = default_share_type
share_name_template = share-%s
rootwrap_config = /etc/manila/rootwrap.conf
api_paste_config = /etc/manila/api-paste.ini</literal_block>
                            <important>
                                <paragraph>The <literal>default_share_type</literal> option specifies the default share type to
                                    be used when shares are created without specifying the share type in
                                    the request. The default share type that is specified in the
                                    configuration file has to be created with the necessary required
                                    extra-specs (such as <literal>driver_handles_share_servers</literal>) set
                                    appropriately with reference to the driver mode used. This is further
                                    explained in the section discussing the setup and configuration of the
                                    share node.</paragraph>
                            </important>
                        </list_item>
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> and <literal>[keystone_authtoken]</literal> sections, configure
                                Identity service access:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
...
auth_strategy = keystone

[keystone_authtoken]
...
memcached_servers = controller:11211
auth_uri = http://controller:5000
auth_url = http://controller:35357
auth_type = password
project_domain_id = default
user_domain_id = default
project_name = service
username = manila
password = MANILA_PASS</literal_block>
                            <paragraph>Replace <literal>MANILA_PASS</literal> with the password you chose for the <literal>manila</literal>
                                user in the Identity service.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>In the <literal>[DEFAULT]</literal> section, configure the <literal>my_ip</literal> option to use the
                                management interface IP address of the controller node:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
...
my_ip = 10.0.0.11</literal_block>
                        </list_item>
                        <list_item>
                            <paragraph>In the <literal>[oslo_concurrency]</literal> section, configure the lock path:</paragraph>
                            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[oslo_concurrency]
...
lock_path = /var/lock/manila</literal_block>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Populate the Shared File Systems database:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># su -s /bin/sh -c "manila-manage db sync" manila</literal_block>
                    <note>
                        <paragraph>Ignore any deprecation messages in this output.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="finalize-installation" names="finalize\ installation">
            <title>Finalize installation</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Restart the Shared File Systems services:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># service manila-scheduler restart
# service manila-api restart</literal_block>
                </list_item>
            </enumerated_list>
        </section>
    </section>
</document>
