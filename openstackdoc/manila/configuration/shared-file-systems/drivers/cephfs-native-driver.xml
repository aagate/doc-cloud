<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/manila/doc/source/configuration/shared-file-systems/drivers/cephfs-native-driver.rst">
    <section ids="cephfs-native-driver" names="cephfs\ native\ driver">
        <title>CephFS Native driver</title>
        <paragraph>The CephFS Native driver enables the Shared File Systems service to export
            shared file systems to guests using the Ceph network protocol. Guests require a
            Ceph client in order to mount the file system.</paragraph>
        <paragraph>Access is controlled via Ceph’s cephx authentication system. When a user
            requests share access for an ID, Ceph creates a corresponding Ceph auth ID and
            a secret key, if they do not already exist, and authorizes the ID to access
            the share. The client can then mount the share using the ID and the secret
            key.</paragraph>
        <paragraph>To learn more about configuring Ceph clients to access the shares created
            using this driver, please see the Ceph documentation (
            <reference refuri="http://docs.ceph.com/docs/master/cephfs/">http://docs.ceph.com/docs/master/cephfs/</reference>). If you choose to use the kernel
            client rather than the FUSE client, the share size limits set in the
            Shared File Systems service may not be obeyed.</paragraph>
        <section ids="supported-shared-file-systems-and-operations" names="supported\ shared\ file\ systems\ and\ operations">
            <title>Supported shared file systems and operations</title>
            <paragraph>The driver supports CephFS shares.</paragraph>
            <paragraph>The following operations are supported with CephFS back end:</paragraph>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Create a share.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Delete a share.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Allow share access.</paragraph>
                    <bullet_list bullet="-">
                        <list_item>
                            <paragraph><literal>read-only</literal> access level is supported.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph><literal>read-write</literal> access level is supported.</paragraph>
                        </list_item>
                    </bullet_list>
                    <paragraph>Note the following limitation for CephFS shares:</paragraph>
                    <bullet_list bullet="-">
                        <list_item>
                            <paragraph>Only <literal>cephx</literal> access type is supported.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Deny share access.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create a snapshot.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Delete a snapshot.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create a consistency group (CG).</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Delete a CG.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Create a CG snapshot.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Delete a CG snapshot.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="requirements" names="requirements">
            <title>Requirements</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Mitaka or later versions of manila.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Jewel or later versions of Ceph.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>A Ceph cluster with a file system configured (
                        <reference refuri="http://docs.ceph.com/docs/master/cephfs/createfs/">http://docs.ceph.com/docs/master/cephfs/createfs/</reference>)</paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>ceph-common</literal> package installed in the servers running the
                        <literal>manila-share</literal> service.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Ceph client installed in the guest, preferably the FUSE based client,
                        <literal>ceph-fuse</literal>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Network connectivity between your Ceph cluster’s public network and the
                        servers running the <literal>manila-share</literal> service.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Network connectivity between your Ceph cluster’s public network and guests.</paragraph>
                </list_item>
            </bullet_list>
            <important>
                <paragraph>A manila share backed onto CephFS is only as good as the
                    underlying file system. Take care when configuring your Ceph
                    cluster, and consult the latest guidance on the use of
                    CephFS in the Ceph documentation (
                    <reference refuri="http://docs.ceph.com/docs/master/cephfs/">http://docs.ceph.com/docs/master/cephfs/</reference>).</paragraph>
            </important>
        </section>
        <section ids="authorize-the-driver-to-communicate-with-ceph" names="authorize\ the\ driver\ to\ communicate\ with\ ceph">
            <title>Authorize the driver to communicate with Ceph</title>
            <paragraph>Run the following commands to create a Ceph identity for the Shared File
                Systems service to use:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">read -d '' MON_CAPS &lt;&lt; EOF
allow r,
allow command "auth del",
allow command "auth caps",
allow command "auth get",
allow command "auth get-or-create"
EOF

ceph auth get-or-create client.manila -o manila.keyring \
mds 'allow *' \
osd 'allow rw' \
mon "$MON_CAPS"</literal_block>
            <paragraph><literal>manila.keyring</literal>, along with your <literal>ceph.conf</literal> file, then needs to be placed
                on the server running the <literal>manila-share</literal> service.</paragraph>
            <paragraph>Enable snapshots in Ceph if you want to use them in the Shared File Systems
                service:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">ceph mds set allow_new_snaps true --yes-i-really-mean-it</literal_block>
            <paragraph>In the server running the <literal>manila-share</literal> service, you can place the
                <literal>ceph.conf</literal> and <literal>manila.keyring</literal> files in the <literal>/etc/ceph</literal> directory. Set
                the same owner for the <literal>manila-share</literal> process and the <literal>manila.keyring</literal>
                file. Add the following section to the <literal>ceph.conf</literal> file.</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[client.manila]
client mount uid = 0
client mount gid = 0
log file = /opt/stack/logs/ceph-client.manila.log
admin socket = /opt/stack/status/stack/ceph-$name.$pid.asok
keyring = /etc/ceph/manila.keyring</literal_block>
            <paragraph>It is advisable to modify the Ceph client’s admin socket file and log file
                locations so that they are co-located with the Shared File Systems services’
                pid files and log files respectively.</paragraph>
        </section>
        <section ids="configure-cephfs-back-end-in-manila-conf" names="configure\ cephfs\ back\ end\ in\ manila.conf">
            <title>Configure CephFS back end in <literal>manila.conf</literal></title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Add CephFS to <literal>enabled_share_protocols</literal> (enforced at the Shared File
                        Systems service’s API layer). In this example we leave NFS and CIFS enabled,
                        although you can remove these if you only use CephFS:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">enabled_share_protocols = NFS,CIFS,CEPHFS</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Refer to the following table for the list of all the <literal>cephfs_native</literal>
                        driver-specific configuration options.</paragraph>
                    <comment xml:space="preserve">Warning: Do not edit this file. It is automatically generated from the
software project's code and your changes will be overwritten.

The tool to generate this file lives in openstack-doc-tools repository.

Please make any changes needed in the code, then run the
autogenerate-config-doc tool from the openstack-doc-tools repository, or
ask for help on the documentation mailing list, IRC channel or meeting.</comment>
                    <target refid="manila-cephfs"></target>
                    <table classes="config-ref-table" ids="id1 manila-cephfs" names="manila-cephfs">
                        <title>Description of CephFS share driver configuration options</title>
                        <tgroup cols="2">
                            <colspec colwidth="50"></colspec>
                            <colspec colwidth="50"></colspec>
                            <thead>
                                <row>
                                    <entry>
                                        <paragraph>Configuration option = Default value</paragraph>
                                    </entry>
                                    <entry>
                                        <paragraph>Description</paragraph>
                                    </entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>
                                        <paragraph><strong>[DEFAULT]</strong></paragraph>
                                    </entry>
                                    <entry>
                                    </entry>
                                </row>
                                <row>
                                    <entry>
                                        <paragraph><literal>cephfs_auth_id</literal> = <literal>manila</literal></paragraph>
                                    </entry>
                                    <entry>
                                        <paragraph>(String) The name of the ceph auth identity to use.</paragraph>
                                    </entry>
                                </row>
                                <row>
                                    <entry>
                                        <paragraph><literal>cephfs_cluster_name</literal> = <literal>None</literal></paragraph>
                                    </entry>
                                    <entry>
                                        <paragraph>(String) The name of the cluster in use, if it is not the default (‘ceph’).</paragraph>
                                    </entry>
                                </row>
                                <row>
                                    <entry>
                                        <paragraph><literal>cephfs_conf_path</literal> =</paragraph>
                                    </entry>
                                    <entry>
                                        <paragraph>(String) Fully qualified path to the ceph.conf file.</paragraph>
                                    </entry>
                                </row>
                                <row>
                                    <entry>
                                        <paragraph><literal>cephfs_enable_snapshots</literal> = <literal>False</literal></paragraph>
                                    </entry>
                                    <entry>
                                        <paragraph>(Boolean) Whether to enable snapshots in this driver.</paragraph>
                                    </entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                    <paragraph>Create a section to define a CephFS back end:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[cephfs1]
driver_handles_share_servers = False
share_backend_name = CEPHFS1
share_driver = manila.share.drivers.cephfs.cephfs_native.CephFSNativeDriver
cephfs_conf_path = /etc/ceph/ceph.conf
cephfs_auth_id = manila
cephfs_cluster_name = ceph
cephfs_enable_snapshots = True</literal_block>
                    <paragraph>Set <literal>cephfs_enable_snapshots</literal> to <literal>True</literal> in the section to let the driver
                        perform snapshot-related operations. Also set the
                        <literal>driver-handles-share-servers</literal> to <literal>False</literal> as the driver does not manage
                        the lifecycle of <literal>share-servers</literal>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Edit <literal>enabled_share_backends</literal> to point to the driver’s back-end section
                        using the section name. In this example we are also including another
                        back end (<literal>generic1</literal>), you would include whatever other back ends you have
                        configured.</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">enabled_share_backends = generic1,cephfs1</literal_block>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="creating-shares" names="creating\ shares">
            <title>Creating shares</title>
            <paragraph>The default share type may have <literal>driver_handles_share_servers</literal> set to
                <literal>True</literal>. Configure a share type suitable for CephFS:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila type-create cephfstype false

manila type-set cephfstype set share_backend_name='CEPHFS1'</literal_block>
            <paragraph>Then create a share:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila create --share-type cephfstype --name cephshare1 cephfs 1</literal_block>
            <paragraph>Note the export location of the share:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila share-export-location-list cephshare1</literal_block>
            <paragraph>The export location of the share contains the Ceph monitor (mon) addresses and
                ports, and the path to be mounted. It is of the form,
                <literal>{mon ip addr:port}[,{mon ip addr:port}]:{path to be mounted}</literal></paragraph>
        </section>
        <section ids="allowing-access-to-shares" names="allowing\ access\ to\ shares">
            <title>Allowing access to shares</title>
            <paragraph>Allow Ceph auth ID <literal>alice</literal> access to the share using <literal>cephx</literal> access type.</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila access-allow cephshare1 cephx alice</literal_block>
            <paragraph>Note the access status and the secret access key of <literal>alice</literal>.</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila access-list cephshare1</literal_block>
        </section>
        <section ids="mounting-shares-using-fuse-client" names="mounting\ shares\ using\ fuse\ client">
            <title>Mounting shares using FUSE client</title>
            <paragraph>Using the secret key of the authorized ID <literal>alice</literal>, create a keyring file
                <literal>alice.keyring</literal>.</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[client.alice]
        key = AQA8+ANW/4ZWNRAAOtWJMFPEihBA1unFImJczA==</literal_block>
            <paragraph>Using the monitor IP addresses from the share’s export location, create a
                configuration file, <literal>ceph.conf</literal>:</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[client]
        client quota = true
        mon host = 192.168.1.7:6789, 192.168.1.8:6789, 192.168.1.9:6789</literal_block>
            <paragraph>Finally, mount the file system, substituting the file names of the keyring and
                configuration files you just created, and substituting the path to be mounted
                from the share’s export location:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">sudo ceph-fuse ~/mnt \
--id=alice \
--conf=./ceph.conf \
--keyring=./alice.keyring \
--client-mountpoint=/volumes/_nogroup/4c55ad20-9c55-4a5e-9233-8ac64566b98c</literal_block>
        </section>
        <section ids="known-restrictions" names="known\ restrictions">
            <title>Known restrictions</title>
            <paragraph>Consider the driver as a building block for supporting multi-tenant workloads
                in the future. However, it can be used in private cloud deployments.</paragraph>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>The guests have direct access to Ceph’s public network.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>The snapshot support of the driver is disabled by default.
                        <literal>cephfs_enable_snapshots</literal> configuration option needs to be set to <literal>True</literal>
                        to allow snapshot operations.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Snapshots are read-only. A user can read a snapshot’s contents from the
                        <literal>.snap/{manila-snapshot-id}_{unknown-id}</literal> folder within the mounted
                        share.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>To restrict share sizes, CephFS uses quotas that are enforced in the client
                        side. The CephFS clients are relied on to respect quotas.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="security" names="security">
            <title>Security</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>Each share’s data is mapped to a distinct Ceph RADOS namespace. A guest is
                        restricted to access only that particular RADOS namespace.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>An additional level of resource isolation can be provided by mapping a
                        share’s contents to a separate RADOS pool. This layout would be preferred
                        only for cloud deployments with a limited number of shares needing strong
                        resource separation. You can do this by setting a share type specification,
                        <literal>cephfs:data_isolated</literal> for the share type used by the cephfs driver.</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">manila type-key cephfstype set cephfs:data_isolated=True</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Untrusted manila guests pose security risks to the Ceph storage cluster as
                        they would have direct access to the cluster’s public network.</paragraph>
                </list_item>
            </bullet_list>
        </section>
    </section>
</document>
