<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/glance/doc/source/user/signature.rst">
    <comment xml:space="preserve">Copyright 2016 OpenStack Foundation
All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations
under the License.</comment>
    <section ids="image-signature-verification" names="image\ signature\ verification">
        <title>Image Signature Verification</title>
        <paragraph>Glance has the ability to perform image validation using a digital
            signature and asymmetric cryptography.  To trigger this, you must define
            specific image properties (described below), and have stored a
            certificate signed with your private key in a local Barbican installation.</paragraph>
        <paragraph>When the image properties exist on an image, Glance will validate
            the uploaded image data against these properties before storing it.
            If validation is unsuccessful, the upload will fail and the image will
            be deleted.</paragraph>
        <paragraph>Additionally, the image properties may be used by other services (for
            example, Nova) to perform data verification when the image is downloaded
            from Glance.</paragraph>
        <section ids="requirements" names="requirements">
            <title>Requirements</title>
            <paragraph>Barbican key manager - See <reference refuri="http://docs.openstack.org/developer/barbican/setup/devstack.html">http://docs.openstack.org/developer/barbican/setup/devstack.html</reference></paragraph>
        </section>
        <section ids="configuration" names="configuration">
            <title>Configuration</title>
            <paragraph>The etc/glance-api.conf can be modified to change keystone endpoint of
                barbican. By default barbican will try to connect to keystone at
                <reference refuri="http://localhost:5000/v3">http://localhost:5000/v3</reference> but if keystone is on another host then this
                should be changed.</paragraph>
            <paragraph>In glance-api.conf find the following lines:</paragraph>
            <literal_block xml:space="preserve">[barbican]
auth_endpoint = http://localhost:5000/v3</literal_block>
            <paragraph>Then replace <reference refuri="http://localhost:5000/v3">http://localhost:5000/v3</reference> with the URL of keystone, also adding /v3
                to the end of it. For example, ‘<reference refuri="https://192.168.245.9:5000/v3">https://192.168.245.9:5000/v3</reference>’.</paragraph>
            <paragraph>Another option in etc/glance-api.conf which can be configured is which key manager
                to use. By default Glance will use the default key manager defined by the Castellan
                key manager interface, which is currently the Barbican key manager.</paragraph>
            <paragraph>In glance-api.conf find the following lines:</paragraph>
            <literal_block xml:space="preserve">[key_manager]
api_class = castellan.key_manager.barbican_key_manager.BarbicanKeyManager</literal_block>
            <paragraph>Then replace the value with the desired key manager class.</paragraph>
            <note>
                <paragraph>If those lines do not exist then simply add them to the end of the file.</paragraph>
            </note>
        </section>
        <section ids="using-the-signature-verification" names="using\ the\ signature\ verification">
            <title>Using the Signature Verification</title>
            <paragraph>An image will need a few properties for signature verification to be enabled,
                these are:</paragraph>
            <literal_block xml:space="preserve">img_signature
img_signature_hash_method
img_signature_key_type
img_signature_certificate_uuid</literal_block>
            <section ids="property-img-signature" names="property\ img_signature">
                <title>Property img_signature</title>
                <paragraph>This is the signature of your image.</paragraph>
                <note>
                    <paragraph>The max character limit is 255.</paragraph>
                </note>
            </section>
            <section ids="property-img-signature-hash-method" names="property\ img_signature_hash_method">
                <title>Property img_signature_hash_method</title>
                <paragraph>Hash methods is the method you hash with.</paragraph>
                <paragraph>Current ones you can use are:</paragraph>
                <bullet_list bullet="*">
                    <list_item>
                        <paragraph>SHA-224</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>SHA-256</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>SHA-384</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>SHA-512</paragraph>
                    </list_item>
                </bullet_list>
            </section>
            <section ids="property-img-signature-key-type" names="property\ img_signature_key_type">
                <title>Property img_signature_key_type</title>
                <paragraph>This is the key_types you can use for your image.</paragraph>
                <paragraph>Current ones you can use are:</paragraph>
                <bullet_list bullet="*">
                    <list_item>
                        <paragraph>RSA-PSS</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>DSA</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>ECC-CURVES</paragraph>
                    </list_item>
                </bullet_list>
                <block_quote>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>SECT571K1</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>SECT409K1</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>SECT571R1</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>SECT409R1</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>SECP521R1</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>SECP384R1</paragraph>
                        </list_item>
                    </bullet_list>
                </block_quote>
                <note>
                    <paragraph>ECC curves - Only keysizes above 384 are included.
                        Not all ECC curves may be supported by the back end.</paragraph>
                </note>
            </section>
            <section ids="property-img-signature-certificate-uuid" names="property\ img_signature_certificate_uuid">
                <title>Property img_signature_certificate_uuid</title>
                <paragraph>This is the UUID of the certificate that you upload to Barbican.</paragraph>
                <paragraph>Therefore the type passed to glance is:</paragraph>
                <bullet_list bullet="*">
                    <list_item>
                        <paragraph>UUID</paragraph>
                    </list_item>
                </bullet_list>
                <note>
                    <paragraph>The supported certificate types are:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>X_509</paragraph>
                        </list_item>
                    </bullet_list>
                </note>
            </section>
        </section>
        <section ids="example-usage" names="example\ usage">
            <title>Example Usage</title>
            <paragraph>Follow these instructions to create your keys:</paragraph>
            <literal_block xml:space="preserve">$ openssl genrsa -out private_key.pem 1024
Generating RSA private key, 1024 bit long modulus
...............................................++++++
..++++++
e is 65537 (0x10001)

$ openssl rsa -pubout -in private_key.pem -out public_key.pem
writing RSA key

$ openssl req -new -key private_key.pem -out cert_request.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.

$ openssl x509 -req -days 14 -in cert_request.csr -signkey private_key.pem -out new_cert.crt
Signature ok
subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd
Getting Private key</literal_block>
            <paragraph>Upload your certificate. This only has to be done once as you can use
                the same <literal>Secret href</literal> for many images until it expires:</paragraph>
            <literal_block xml:space="preserve">$ openstack secret store --name test --algorithm RSA --expiration 2016-06-29 --secret-type certificate --payload-content-type "application/octet-stream" --payload-content-encoding base64 --payload "$(base64 new_cert.crt)"
+---------------+-----------------------------------------------------------------------+
| Field         | Value                                                                 |
+---------------+-----------------------------------------------------------------------+
| Secret href   | http://127.0.0.1:9311/v1/secrets/cd7cc675-e573-419c-8fff-33a72734a243 |

$ cert_uuid=cd7cc675-e573-419c-8fff-33a72734a243</literal_block>
            <paragraph>Get an image and create the signature:</paragraph>
            <literal_block xml:space="preserve">$ echo This is a dodgy image &gt; myimage

$ openssl dgst -sha256 -sign private_key.pem -sigopt rsa_padding_mode:pss -out myimage.signature myimage

$ base64 -w 0 myimage.signature &gt; myimage.signature.b64

$ image_signature=$(cat myimage.signature.b64)</literal_block>
            <note>
                <paragraph>Using Glance v1 requires ‘-w 0’ due to not supporting multiline image properties.
                    Glance v2 does support multiline image properties and does not require ‘-w 0’ but may still be used.</paragraph>
            </note>
            <paragraph>Create the image:</paragraph>
            <literal_block xml:space="preserve">$ glance image-create --name mySignedImage --container-format bare --disk-format qcow2 --property img_signature="$image_signature" --property img_signature_certificate_uuid="$cert_uuid" --property img_signature_hash_method='SHA-256' --property img_signature_key_type='RSA-PSS' &lt; myimage</literal_block>
            <note>
                <paragraph>Creating the image can fail if validation does not succeed.
                    This will cause the image to be deleted.</paragraph>
            </note>
        </section>
        <section ids="other-links" names="other\ links">
            <title>Other Links</title>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><reference refuri="https://etherpad.openstack.org/p/mitaka-glance-image-signing-instructions">https://etherpad.openstack.org/p/mitaka-glance-image-signing-instructions</reference></paragraph>
                </list_item>
                <list_item>
                    <paragraph><reference refuri="http://docs.openstack.org/ops-guide/ops_user_facing_operations.html">http://docs.openstack.org/ops-guide/ops_user_facing_operations.html</reference></paragraph>
                </list_item>
            </bullet_list>
        </section>
    </section>
</document>
