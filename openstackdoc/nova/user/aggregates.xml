<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/nova/doc/source/user/aggregates.rst">
    <comment xml:space="preserve">Copyright 2012 OpenStack Foundation
Copyright 2012 Citrix Systems, Inc.
Copyright 2012, The Cloudscaling Group, Inc.
All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations
under the License.</comment>
    <section ids="host-aggregates" names="host\ aggregates">
        <title>Host Aggregates</title>
        <paragraph>Host aggregates can be regarded as a mechanism to further partition an availability zone; while availability zones are visible to users, host aggregates are only visible to administrators.  Host aggregates started out as a way to use Xen hypervisor resource pools, but has been generalized to provide a mechanism to allow administrators to assign key-value pairs to groups of machines.  Each node can have multiple aggregates, each aggregate can have multiple key-value pairs, and the same key-value pair can be assigned to multiple aggregate.  This information can be used in the scheduler to enable advanced scheduling, to set up xen hypervisor resources pools or to define logical groups for migration.</paragraph>
        <section ids="availability-zones-azs" names="availability\ zones\ (azs)">
            <title>Availability Zones (AZs)</title>
            <paragraph>Availability Zones are the end-user visible logical abstraction for
                partitioning a cloud without knowing the physical infrastructure.
                That abstraction doesn't come up in Nova with an actual database model since
                the availability zone is actually a specific metadata information attached to
                an aggregate. Adding that specific metadata to an aggregate makes the aggregate
                visible from an end-user perspective and consequently allows to schedule upon a
                specific set of hosts (the ones belonging to the aggregate).</paragraph>
            <paragraph>That said, there are a few rules to know that diverge from an API perspective
                between aggregates and availability zones:</paragraph>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>one host can be in multiple aggregates, but it can only be in one
                        availability zone</paragraph>
                </list_item>
                <list_item>
                    <paragraph>by default a host is part of a default availability zone even if it doesn't
                        belong to an aggregate (the configuration option is named
                        <literal>default_availability_zone</literal>)</paragraph>
                </list_item>
            </bullet_list>
            <warning>
                <paragraph>That last rule can be very error-prone. Since the user can see the
                    list of availability zones, they have no way to know whether the default
                    availability zone name (currently <emphasis>nova</emphasis>) is provided because an host
                    belongs to an aggregate whose AZ metadata key is set to <emphasis>nova</emphasis>, or because
                    there are at least one host belonging to no aggregate. Consequently, it is
                    highly recommended for users to never ever ask for booting an instance by
                    specifying an explicit AZ named <emphasis>nova</emphasis> and for operators to never set the
                    AZ metadata for an aggregate to <emphasis>nova</emphasis>. That leads to some problems
                    due to the fact that the instance AZ information is explicitly attached to
                    <emphasis>nova</emphasis> which could break further move operations when either the host is
                    moved to another aggregate or when the user would like to migrate the
                    instance.</paragraph>
            </warning>
            <note>
                <paragraph>Availablity zone name must NOT contain ':' since it is used by admin
                    users to specify hosts where instances are launched in server creation.
                    See <reference internal="True" refuri="../admin/availability-zones"><inline classes="doc">Select hosts where instances are launched</inline></reference> for more detail.</paragraph>
            </note>
        </section>
        <section ids="xen-pool-host-aggregates" names="xen\ pool\ host\ aggregates">
            <title>Xen Pool Host Aggregates</title>
            <paragraph>Originally all aggregates were Xen resource pools, now an aggregate can be set up as a resource pool by giving the aggregate the correct key-value pair.</paragraph>
            <paragraph>You can use aggregates for XenServer resource pools when you have multiple compute nodes installed (only XenServer/XCP via xenapi driver is currently supported), and you want to leverage the capabilities of the underlying hypervisor resource pools. For example, you want to enable VM live migration (i.e. VM migration within the pool) or enable host maintenance with zero-downtime for guest instances. Please, note that VM migration across pools (i.e. storage migration) is not yet supported in XenServer/XCP, but will be added when available. Bear in mind that the two migration techniques are not mutually exclusive and can be used in combination for a higher level of flexibility in your cloud management.</paragraph>
        </section>
        <section ids="design" names="design">
            <title>Design</title>
            <paragraph>The OSAPI Admin API is extended to support the following operations:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph>Aggregates</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>list aggregates: returns a list of all the host-aggregates (optionally filtered by availability zone)</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>create aggregate: creates an aggregate, takes a friendly name, etc. returns an id</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>show aggregate: shows the details of an aggregate (id, name, availability_zone, hosts and metadata)</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>update aggregate: updates the name and availability zone of an aggregate</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>set metadata: sets the metadata on an aggregate to the values supplied</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>delete aggregate: deletes an aggregate, it fails if the aggregate is not empty</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>add host: adds a host to the aggregate</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>remove host: removes a host from the aggregate</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Hosts</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>start host maintenance (or evacuate-host): disallow a host to serve API requests and migrate instances to other hosts of the aggregate</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>stop host maintenance: (or rebalance-host): put the host back into operational mode, migrating instances back onto that host</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
            </bullet_list>
        </section>
        <section ids="using-the-nova-cli" names="using\ the\ nova\ cli">
            <title>Using the Nova CLI</title>
            <paragraph>Using the nova command you can create, delete and manage aggregates. The following section outlines the list of available commands.</paragraph>
            <section ids="usage" names="usage">
                <title>Usage</title>
                <literal_block xml:space="preserve">* aggregate-list                                                    Print a list of all aggregates.
* aggregate-create         &lt;name&gt; &lt;availability_zone&gt;               Create a new aggregate with the specified details.
* aggregate-delete         &lt;id&gt;                                     Delete the aggregate by its id.
* aggregate-details        &lt;id&gt;                                     Show details of the specified aggregate.
* aggregate-add-host       &lt;id&gt; &lt;host&gt;                              Add the host to the specified aggregate.
* aggregate-remove-host    &lt;id&gt; &lt;host&gt;                              Remove the specified host from the specified aggregate.
* aggregate-set-metadata   &lt;id&gt; &lt;key=value&gt; [&lt;key=value&gt; ...]       Update the metadata associated with the aggregate.
* aggregate-update         &lt;id&gt; &lt;name&gt; [&lt;availability_zone&gt;]        Update the aggregate's name and optionally availability zone.

* host-list                                                         List all hosts by service
* host-update              --maintenance [enable | disable]         Put/resume host into/from maintenance.</literal_block>
            </section>
        </section>
    </section>
</document>
