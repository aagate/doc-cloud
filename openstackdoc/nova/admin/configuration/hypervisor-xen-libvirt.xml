<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/nova/doc/source/admin/configuration/hypervisor-xen-libvirt.rst">
    <section ids="xen-via-libvirt" names="xen\ via\ libvirt">
        <title>Xen via libvirt</title>
        <paragraph>OpenStack Compute supports the Xen Project Hypervisor (or Xen). Xen can be
            integrated with OpenStack Compute via the <reference name="libvirt" refuri="http://libvirt.org/">libvirt</reference><target ids="libvirt" names="libvirt" refuri="http://libvirt.org/"></target>
            <reference name="toolstack" refuri="http://wiki.xen.org/wiki/Choice_of_Toolstacks">toolstack</reference><target ids="toolstack" names="toolstack" refuri="http://wiki.xen.org/wiki/Choice_of_Toolstacks"></target> or via the <reference name="XAPI" refuri="http://xenproject.org/developers/teams/xapi.html">XAPI</reference><target ids="xapi" names="xapi" refuri="http://xenproject.org/developers/teams/xapi.html"></target> <reference name="toolstack" refuri="http://wiki.xen.org/wiki/Choice_of_Toolstacks">toolstack</reference><target dupnames="toolstack" ids="id1" refuri="http://wiki.xen.org/wiki/Choice_of_Toolstacks"></target>.  This section describes how
            to set up OpenStack Compute with Xen and libvirt.  For information on how to
            set up Xen with XAPI refer to <reference internal="True" refuri="hypervisor-xen-api"><inline classes="doc">XenServer (and other XAPI based Xen variants)</inline></reference>.</paragraph>
        <section ids="installing-xen-with-libvirt" names="installing\ xen\ with\ libvirt">
            <title>Installing Xen with libvirt</title>
            <paragraph>At this stage we recommend using the baseline that we use for the <reference name="Xen Project OpenStack CI Loop" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt">Xen Project
                    OpenStack CI Loop</reference><target ids="xen-project-openstack-ci-loop" names="xen\ project\ openstack\ ci\ loop" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt"></target>, which
                contains the most recent stability fixes to both Xen and libvirt.</paragraph>
            <paragraph><reference name="Xen 4.5.1" refuri="http://www.xenproject.org/downloads/xen-archives/xen-45-series/xen-451.html">Xen 4.5.1</reference><target ids="xen-4-5-1" names="xen\ 4.5.1" refuri="http://www.xenproject.org/downloads/xen-archives/xen-45-series/xen-451.html"></target>
                (or newer) and <reference name="libvirt 1.2.15" refuri="http://libvirt.org/sources/">libvirt 1.2.15</reference><target ids="libvirt-1-2-15" names="libvirt\ 1.2.15" refuri="http://libvirt.org/sources/"></target> (or newer)
                contain the minimum required OpenStack improvements for Xen.  Although libvirt
                1.2.15 works with Xen, libvirt 1.3.2 or newer is recommended.  The necessary
                Xen changes have also been backported to the Xen 4.4.3 stable branch. Please
                check with the Linux and FreeBSD distros you are intending to use as <reference name="Dom 0" refuri="http://wiki.xenproject.org/wiki/Category:Host_Install">Dom 0</reference><target ids="dom-0" names="dom\ 0" refuri="http://wiki.xenproject.org/wiki/Category:Host_Install"></target>, whether the relevant
                version of Xen and libvirt are available as installable packages.</paragraph>
            <paragraph>The latest releases of Xen and libvirt packages that fulfil the above minimum
                requirements for the various openSUSE distributions can always be found and
                installed from the <reference name="Open Build Service" refuri="https://build.opensuse.org/project/show/Virtualization">Open Build Service</reference><target ids="open-build-service" names="open\ build\ service" refuri="https://build.opensuse.org/project/show/Virtualization"></target> Virtualization
                project.  To install these latest packages, add the Virtualization repository
                to your software management stack and get the newest packages from there.  More
                information about the latest Xen and libvirt packages are available <reference name="here" refuri="https://build.opensuse.org/package/show/Virtualization/xen">here</reference> and <reference name="here" refuri="https://build.opensuse.org/package/show/Virtualization/libvirt">here</reference>.</paragraph>
            <paragraph>Alternatively, it is possible to use the Ubuntu LTS 14.04 Xen Package
                <strong>4.4.1-0ubuntu0.14.04.4</strong> (Xen 4.4.1) and apply the patches outlined <reference name="here" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt#Baseline">here</reference>.
                You can also use the Ubuntu LTS 14.04 libvirt package <strong>1.2.2
                    libvirt_1.2.2-0ubuntu13.1.7</strong> as baseline and update it to libvirt version
                1.2.15, or 1.2.14 with the patches outlined <reference name="here" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt#Baseline">here</reference>
                applied.  Note that this will require rebuilding these packages partly from
                source.</paragraph>
            <paragraph>For further information and latest developments, you may want to consult the
                Xen Project's <reference name="mailing lists for OpenStack related issues and questions" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack">mailing lists for OpenStack related issues and questions</reference><target ids="mailing-lists-for-openstack-related-issues-and-questions" names="mailing\ lists\ for\ openstack\ related\ issues\ and\ questions" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack"></target>.</paragraph>
        </section>
        <section ids="configuring-xen-with-libvirt" names="configuring\ xen\ with\ libvirt">
            <title>Configuring Xen with libvirt</title>
            <paragraph>To enable Xen via libvirt, ensure the following options are set in
                <literal>/etc/nova/nova.conf</literal> on all hosts running the <literal>nova-compute</literal> service.</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">compute_driver = libvirt.LibvirtDriver

[libvirt]
virt_type = xen</literal_block>
        </section>
        <section ids="additional-configuration-options" names="additional\ configuration\ options">
            <title>Additional configuration options</title>
            <paragraph>Use the following as a guideline for configuring Xen for use in OpenStack:</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph><strong>Dom0 memory</strong>: Set it between 1GB and 4GB by adding the following
                        parameter to the Xen Boot Options in the <reference name="grub.conf" refuri="http://xenbits.xen.org/docs/unstable/misc/xen-command-line.html">grub.conf</reference><target ids="grub-conf" names="grub.conf" refuri="http://xenbits.xen.org/docs/unstable/misc/xen-command-line.html"></target> file.</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">dom0_mem=1024M</literal_block>
                    <note>
                        <paragraph>The above memory limits are suggestions and should be based on the
                            available compute host resources. For large hosts that will run many
                            hundreds of instances, the suggested values may need to be higher.</paragraph>
                    </note>
                    <note>
                        <paragraph>The location of the grub.conf file depends on the host Linux distribution
                            that you are using. Please refer to the distro documentation for more
                            details (see <reference name="Dom 0" refuri="http://wiki.xenproject.org/wiki/Category:Host_Install">Dom 0</reference><target dupnames="dom\ 0" ids="id2" refuri="http://wiki.xenproject.org/wiki/Category:Host_Install"></target> for more resources).</paragraph>
                    </note>
                </list_item>
                <list_item>
                    <paragraph><strong>Dom0 vcpus</strong>: Set the virtual CPUs to 4 and employ CPU pinning by adding
                        the following parameters to the Xen Boot Options in the <reference name="grub.conf" refuri="http://xenbits.xen.org/docs/unstable/misc/xen-command-line.html">grub.conf</reference><target dupnames="grub.conf" ids="id3" refuri="http://xenbits.xen.org/docs/unstable/misc/xen-command-line.html"></target> file.</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">dom0_max_vcpus=4 dom0_vcpus_pin</literal_block>
                    <note>
                        <paragraph>Note that the above virtual CPU limits are suggestions and should be
                            based on the available compute host resources. For large hosts, that will
                            run many hundred of instances, the suggested values may need to be
                            higher.</paragraph>
                    </note>
                </list_item>
                <list_item>
                    <paragraph><strong>PV vs HVM guests</strong>: A Xen virtual machine can be paravirtualized (PV) or
                        hardware virtualized (HVM). The virtualization mode determines the
                        interaction between Xen, Dom 0, and the guest VM's kernel. PV guests are
                        aware of the fact that they are virtualized and will co-operate with Xen and
                        Dom 0. The choice of virtualization mode determines performance
                        characteristics. For an overview of Xen virtualization modes, see <reference name="Xen Guest Types" refuri="http://wiki.xen.org/wiki/Xen_Overview#Guest_Types">Xen Guest
                            Types</reference><target ids="xen-guest-types" names="xen\ guest\ types" refuri="http://wiki.xen.org/wiki/Xen_Overview#Guest_Types"></target>.</paragraph>
                    <paragraph>In OpenStack, customer VMs may run in either PV or HVM mode.  The mode is a
                        property of the operating system image used by the VM, and is changed by
                        adjusting the image metadata stored in the Image service.  The image
                        metadata can be changed using the <literal_strong classes="command">openstack</literal_strong> commands.</paragraph>
                    <paragraph>To choose one of the HVM modes (HVM, HVM with PV Drivers or PVHVM), use
                        <literal_strong classes="command">openstack</literal_strong> to set the <literal>vm_mode</literal> property to <literal>hvm</literal>.</paragraph>
                    <paragraph>To choose one of the HVM modes (HVM, HVM with PV Drivers or PVHVM), use one
                        of the following two commands:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack image set --property vm_mode=hvm IMAGE</literal_block>
                    <paragraph>To chose PV mode, which is supported by NetBSD, FreeBSD and Linux, use one
                        of the following two commands</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack image set --property vm_mode=xen IMAGE</literal_block>
                    <note>
                        <paragraph>The default for virtualization mode in nova is PV mode.</paragraph>
                    </note>
                </list_item>
                <list_item>
                    <paragraph><strong>Image formats</strong>: Xen supports raw, qcow2 and vhd image formats.  For more
                        information on image formats, refer to the <reference name="OpenStack Virtual Image Guide" refuri="https://docs.openstack.org/image-guide/introduction.html">OpenStack Virtual Image Guide</reference> and the
                        <reference name="Storage Options Guide on the Xen Project Wiki" refuri="http://wiki.xenproject.org/wiki/Storage_options">Storage Options Guide on the Xen Project Wiki</reference><target ids="storage-options-guide-on-the-xen-project-wiki" names="storage\ options\ guide\ on\ the\ xen\ project\ wiki" refuri="http://wiki.xenproject.org/wiki/Storage_options"></target>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph><strong>Image metadata</strong>: In addition to the <literal>vm_mode</literal> property discussed above,
                        the <literal>hypervisor_type</literal> property is another important component of the image
                        metadata, especially if your cloud contains mixed hypervisor compute nodes.
                        Setting the <literal>hypervisor_type</literal> property allows the nova scheduler to select
                        a compute node running the specified hypervisor when launching instances of
                        the image. Image metadata such as <literal>vm_mode</literal>, <literal>hypervisor_type</literal>,
                        architecture, and others can be set when importing the image to the Image
                        service. The metadata can also be changed using the <literal_strong classes="command">openstack</literal_strong>
                        commands:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack image set --property hypervisor_type=xen vm_mode=hvm IMAGE</literal_block>
                    <paragraph>For more more information on image metadata, refer to the <reference name="OpenStack Virtual Image Guide" refuri="https://docs.openstack.org/image-guide/image-metadata.html">OpenStack Virtual
                            Image Guide</reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph><strong>Libguestfs file injection</strong>: OpenStack compute nodes can use <reference name="libguestfs" refuri="http://libguestfs.org/">libguestfs</reference><target ids="libguestfs" names="libguestfs" refuri="http://libguestfs.org/"></target> to inject files into an instance's image prior to
                        launching the instance. libguestfs uses libvirt's QEMU driver to start a
                        qemu process, which is then used to inject files into the image. When using
                        libguestfs for file injection, the compute node must have the libvirt qemu
                        driver installed, in addition to the Xen driver. In RPM based distributions,
                        the qemu driver is provided by the <literal>libvirt-daemon-qemu</literal> package. In
                        Debian and Ubuntu, the qemu driver is provided by the <literal>libvirt-bin</literal>
                        package.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="troubleshoot-xen-with-libvirt" names="troubleshoot\ xen\ with\ libvirt">
            <title>Troubleshoot Xen with libvirt</title>
            <paragraph><strong>Important log files</strong>: When an instance fails to start, or when you come
                across other issues, you should first consult the following log files:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><literal>/var/log/nova/nova-compute.log</literal></paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>/var/log/libvirt/libxl/libxl-driver.log</literal>,</paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>/var/log/xen/qemu-dm-${instancename}.log</literal>,</paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>/var/log/xen/xen-hotplug.log</literal>,</paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>/var/log/xen/console/guest-${instancename}</literal> (to enable see <reference name="Enabling Guest Console Logs" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen#Guest_console_logs">Enabling Guest
                            Console Logs</reference><target ids="enabling-guest-console-logs" names="enabling\ guest\ console\ logs" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen#Guest_console_logs"></target>)</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Host Console Logs (read <reference name="Enabling and Retrieving Host Console Logs" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen#Host_console_logs">Enabling and Retrieving Host Console Logs</reference><target ids="enabling-and-retrieving-host-console-logs" names="enabling\ and\ retrieving\ host\ console\ logs" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen#Host_console_logs"></target>).</paragraph>
                </list_item>
            </bullet_list>
            <paragraph>If you need further help you can ask questions on the mailing lists <reference name="xen-users@" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/xen-users">xen-users@</reference><target ids="xen-users" names="xen-users@" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/xen-users"></target>,
                <reference name="wg-openstack@" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack">wg-openstack@</reference><target ids="wg-openstack" names="wg-openstack@" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack"></target> or <reference name="raise a bug" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen">raise a bug</reference><target ids="raise-a-bug" names="raise\ a\ bug" refuri="http://wiki.xen.org/wiki/Reporting_Bugs_against_Xen"></target> against Xen.</paragraph>
        </section>
        <section ids="known-issues" names="known\ issues">
            <title>Known issues</title>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><strong>Networking</strong>: Xen via libvirt is currently only supported with
                        nova-network. Fixes for a number of bugs are currently being worked on to
                        make sure that Xen via libvirt will also work with OpenStack Networking
                        (neutron).</paragraph>
                    <target refid="index-0"></target>
                    <todo_node classes="admonition-todo" ids="index-0">
                        <title>Todo</title>
                        <paragraph>Is this still true?</paragraph>
                    </todo_node>
                </list_item>
                <list_item>
                    <paragraph><strong>Live migration</strong>: Live migration is supported in the libvirt libxl driver
                        since version 1.2.5. However, there were a number of issues when used with
                        OpenStack, in particular with libvirt migration protocol compatibility. It is
                        worth mentioning that libvirt 1.3.0 addresses most of these issues.  We do
                        however recommend using libvirt 1.3.2, which is fully supported and tested as
                        part of the Xen Project CI loop. It addresses live migration monitoring
                        related issues and adds support for peer-to-peer migration mode, which nova
                        relies on.</paragraph>
                </list_item>
                <list_item>
                    <paragraph><strong>Live migration monitoring</strong>: On compute nodes running Kilo or later, live
                        migration monitoring relies on libvirt APIs that are only implemented from
                        libvirt version 1.3.1 onwards. When attempting to live migrate, the migration
                        monitoring thread would crash and leave the instance state as "MIGRATING". If
                        you experience such an issue and you are running on a version released before
                        libvirt 1.3.1, make sure you backport libvirt commits ad71665 and b7b4391
                        from upstream.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="additional-information-and-resources" names="additional\ information\ and\ resources">
            <title>Additional information and resources</title>
            <paragraph>The following section contains links to other useful resources.</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><reference name="wiki.xenproject.org/wiki/OpenStack" refuri="http://wiki.xenproject.org/wiki/OpenStack">wiki.xenproject.org/wiki/OpenStack</reference><target ids="wiki-xenproject-org-wiki-openstack" names="wiki.xenproject.org/wiki/openstack" refuri="http://wiki.xenproject.org/wiki/OpenStack"></target> - OpenStack Documentation on the Xen Project wiki</paragraph>
                </list_item>
                <list_item>
                    <paragraph><reference name="wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt">wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt</reference><target ids="wiki-xenproject-org-wiki-openstack-ci-loop-for-xen-libvirt" names="wiki.xenproject.org/wiki/openstack_ci_loop_for_xen-libvirt" refuri="http://wiki.xenproject.org/wiki/OpenStack_CI_Loop_for_Xen-Libvirt"></target> -
                        Information about the Xen Project OpenStack CI Loop</paragraph>
                </list_item>
                <list_item>
                    <paragraph><reference name="wiki.xenproject.org/wiki/OpenStack_via_DevStack" refuri="http://wiki.xenproject.org/wiki/OpenStack_via_DevStack">wiki.xenproject.org/wiki/OpenStack_via_DevStack</reference><target ids="wiki-xenproject-org-wiki-openstack-via-devstack" names="wiki.xenproject.org/wiki/openstack_via_devstack" refuri="http://wiki.xenproject.org/wiki/OpenStack_via_DevStack"></target> - How to set up
                        OpenStack via DevStack</paragraph>
                </list_item>
                <list_item>
                    <paragraph><reference name="Mailing lists for OpenStack related issues and questions" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack">Mailing lists for OpenStack related issues and questions</reference><target dupnames="mailing\ lists\ for\ openstack\ related\ issues\ and\ questions" ids="id4" refuri="http://lists.xenproject.org/cgi-bin/mailman/listinfo/wg-openstack"></target> - This
                        list is dedicated to coordinating bug fixes and issues across Xen, libvirt
                        and OpenStack and the CI loop.</paragraph>
                </list_item>
            </bullet_list>
        </section>
    </section>
</document>
