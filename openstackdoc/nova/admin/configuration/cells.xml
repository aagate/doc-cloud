<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/nova/doc/source/admin/configuration/cells.rst">
    <section ids="cells-v1" names="cells\ (v1)">
        <title>Cells (v1)</title>
        <warning>
            <paragraph>Configuring and implementing Cells v1 is not recommended for new deployments
                of the Compute service (nova). Cells v2 replaces cells v1, and v2 is
                required to install or upgrade the Compute service to the 15.0.0 Ocata
                release. More information on cells v2 can be found in <reference internal="True" refuri="../../user/cells"><inline classes="doc">Cells</inline></reference>.</paragraph>
        </warning>
        <paragraph><title_reference>Cells</title_reference> functionality enables you to scale an OpenStack Compute cloud in a more
            distributed fashion without having to use complicated technologies like
            database and message queue clustering.  It supports very large deployments.</paragraph>
        <paragraph>When this functionality is enabled, the hosts in an OpenStack Compute cloud are
            partitioned into groups called cells. Cells are configured as a tree. The
            top-level cell should have a host that runs a <literal>nova-api</literal> service, but no
            <literal>nova-compute</literal> services.  Each child cell should run all of the typical
            <literal>nova-*</literal> services in a regular Compute cloud except for <literal>nova-api</literal>. You can
            think of cells as a normal Compute deployment in that each cell has its own
            database server and message queue broker.</paragraph>
        <paragraph>The <literal>nova-cells</literal> service handles communication between cells and selects
            cells for new instances. This service is required for every cell. Communication
            between cells is pluggable, and currently the only option is communication
            through RPC.</paragraph>
        <paragraph>Cells scheduling is separate from host scheduling.  <literal>nova-cells</literal> first picks
            a cell. Once a cell is selected and the new build request reaches its
            <literal>nova-cells</literal> service, it is sent over to the host scheduler in that cell and
            the build proceeds as it would have without cells.</paragraph>
        <section ids="cell-configuration-options" names="cell\ configuration\ options">
            <title>Cell configuration options</title>
            <target refid="index-0"></target>
            <todo_node classes="admonition-todo" ids="index-0">
                <title>Todo</title>
                <paragraph>This is duplication. We should be able to use the
                    oslo.config.sphinxext module to generate this for us</paragraph>
            </todo_node>
            <paragraph>Cells are disabled by default. All cell-related configuration options appear in
                the <literal>[cells]</literal> section in <literal>nova.conf</literal>.  The following cell-related options
                are currently supported:</paragraph>
            <definition_list>
                <definition_list_item>
                    <term><literal>enable</literal></term>
                    <definition>
                        <paragraph>Set to <literal>True</literal> to turn on cell functionality. Default is <literal>false</literal>.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>name</literal></term>
                    <definition>
                        <paragraph>Name of the current cell. Must be unique for each cell.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>capabilities</literal></term>
                    <definition>
                        <paragraph>List of arbitrary <literal>key=value</literal> pairs defining capabilities of the current
                            cell. Values include <literal>hypervisor=xenserver;kvm,os=linux;windows</literal>.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>call_timeout</literal></term>
                    <definition>
                        <paragraph>How long in seconds to wait for replies from calls between cells.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>scheduler_filter_classes</literal></term>
                    <definition>
                        <paragraph>Filter classes that the cells scheduler should use.  By default, uses
                            <literal>nova.cells.filters.all_filters</literal> to map to all cells filters included with
                            Compute.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>scheduler_weight_classes</literal></term>
                    <definition>
                        <paragraph>Weight classes that the scheduler for cells uses. By default, uses
                            <literal>nova.cells.weights.all_weighers</literal> to map to all cells weight algorithms
                            included with Compute.</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>ram_weight_multiplier</literal></term>
                    <definition>
                        <paragraph>Multiplier used to weight RAM. Negative numbers indicate that Compute should
                            stack VMs on one host instead of spreading out new VMs to more hosts in the
                            cell. The default value is 10.0.</paragraph>
                    </definition>
                </definition_list_item>
            </definition_list>
        </section>
        <section ids="configure-the-api-top-level-cell" names="configure\ the\ api\ (top-level)\ cell">
            <title>Configure the API (top-level) cell</title>
            <paragraph>The cell type must be changed in the API cell so that requests can be proxied
                through <literal>nova-cells</literal> down to the correct cell properly.  Edit the
                <literal>nova.conf</literal> file in the API cell, and specify <literal>api</literal> in the <literal>cell_type</literal>
                key:</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
compute_api_class=nova.compute.cells_api.ComputeCellsAPI
# ...

[cells]
cell_type= api</literal_block>
        </section>
        <section ids="configure-the-child-cells" names="configure\ the\ child\ cells">
            <title>Configure the child cells</title>
            <paragraph>Edit the <literal>nova.conf</literal> file in the child cells, and specify <literal>compute</literal> in the
                <literal>cell_type</literal> key:</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[DEFAULT]
# Disable quota checking in child cells. Let API cell do it exclusively.
quota_driver=nova.quota.NoopQuotaDriver

[cells]
cell_type = compute</literal_block>
        </section>
        <section ids="configure-the-database-in-each-cell" names="configure\ the\ database\ in\ each\ cell">
            <title>Configure the database in each cell</title>
            <paragraph>Before bringing the services online, the database in each cell needs to be
                configured with information about related cells.  In particular, the API cell
                needs to know about its immediate children, and the child cells must know about
                their immediate agents.  The information needed is the <literal>RabbitMQ</literal> server
                credentials for the particular cell.</paragraph>
            <paragraph>Use the <literal_strong classes="command">nova-manage cell create</literal_strong> command to add this information to
                the database in each cell:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># nova-manage cell create -h
usage: nova-manage cell create [-h] [--name &lt;name&gt;]
                               [--cell_type &lt;parent|api|child|compute&gt;]
                               [--username &lt;username&gt;] [--password &lt;password&gt;]
                               [--broker_hosts &lt;broker_hosts&gt;]
                               [--hostname &lt;hostname&gt;] [--port &lt;number&gt;]
                               [--virtual_host &lt;virtual_host&gt;]
                               [--woffset &lt;float&gt;] [--wscale &lt;float&gt;]

optional arguments:
  -h, --help            show this help message and exit
  --name &lt;name&gt;         Name for the new cell
  --cell_type &lt;parent|api|child|compute&gt;
                        Whether the cell is parent/api or child/compute
  --username &lt;username&gt;
                        Username for the message broker in this cell
  --password &lt;password&gt;
                        Password for the message broker in this cell
  --broker_hosts &lt;broker_hosts&gt;
                        Comma separated list of message brokers in this cell.
                        Each Broker is specified as hostname:port with both
                        mandatory. This option overrides the --hostname and
                        --port options (if provided).
  --hostname &lt;hostname&gt;
                        Address of the message broker in this cell
  --port &lt;number&gt;       Port number of the message broker in this cell
  --virtual_host &lt;virtual_host&gt;
                        The virtual host of the message broker in this cell
  --woffset &lt;float&gt;
  --wscale &lt;float&gt;</literal_block>
            <paragraph>As an example, assume an API cell named <literal>api</literal> and a child cell named
                <literal>cell1</literal>.</paragraph>
            <paragraph>Within the <literal>api</literal> cell, specify the following <literal>RabbitMQ</literal> server information:</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">rabbit_host=10.0.0.10
rabbit_port=5672
rabbit_username=api_user
rabbit_password=api_passwd
rabbit_virtual_host=api_vhost</literal_block>
            <paragraph>Within the <literal>cell1</literal> child cell, specify the following <literal>RabbitMQ</literal> server
                information:</paragraph>
            <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">rabbit_host=10.0.1.10
rabbit_port=5673
rabbit_username=cell1_user
rabbit_password=cell1_passwd
rabbit_virtual_host=cell1_vhost</literal_block>
            <paragraph>You can run this in the API cell as root:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># nova-manage cell create --name cell1 --cell_type child \
  --username cell1_user --password cell1_passwd --hostname 10.0.1.10 \
  --port 5673 --virtual_host cell1_vhost --woffset 1.0 --wscale 1.0</literal_block>
            <paragraph>Repeat the previous steps for all child cells.</paragraph>
            <paragraph>In the child cell, run the following, as root:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># nova-manage cell create --name api --cell_type parent \
  --username api_user --password api_passwd --hostname 10.0.0.10 \
  --port 5672 --virtual_host api_vhost --woffset 1.0 --wscale 1.0</literal_block>
            <paragraph>To customize the Compute cells, use the configuration option settings
                documented above.</paragraph>
        </section>
        <section ids="cell-scheduling-configuration" names="cell\ scheduling\ configuration">
            <title>Cell scheduling configuration</title>
            <paragraph>To determine the best cell to use to launch a new instance, Compute uses a set
                of filters and weights defined in the <literal>/etc/nova/nova.conf</literal> file. The
                following options are available to prioritize cells for scheduling:</paragraph>
            <definition_list>
                <definition_list_item>
                    <term><literal>scheduler_filter_classes</literal></term>
                    <definition>
                        <paragraph>List of filter classes. By default <literal>nova.cells.filters.all_filters</literal>
                            is specified, which maps to all cells filters included with Compute
                            (see the section called <reference internal="True" refuri="schedulers#compute-scheduler-filters"><inline classes="std std-ref">Filters</inline></reference>).</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>scheduler_weight_classes</literal></term>
                    <definition>
                        <paragraph>List of weight classes. By default <literal>nova.cells.weights.all_weighers</literal> is
                            specified, which maps to all cell weight algorithms included with Compute.
                            The following modules are available:</paragraph>
                        <definition_list>
                            <definition_list_item>
                                <term><literal>mute_child</literal></term>
                                <definition>
                                    <paragraph>Downgrades the likelihood of child cells being chosen for scheduling
                                        requests, which haven't sent capacity or capability updates in a while.
                                        Options include <literal>mute_weight_multiplier</literal> (multiplier for mute children;
                                        value should be negative).</paragraph>
                                </definition>
                            </definition_list_item>
                            <definition_list_item>
                                <term><literal>ram_by_instance_type</literal></term>
                                <definition>
                                    <paragraph>Select cells with the most RAM capacity for the instance type being
                                        requested. Because higher weights win, Compute returns the number of
                                        available units for the instance type requested. The
                                        <literal>ram_weight_multiplier</literal> option defaults to 10.0 that adds to the weight
                                        by a factor of 10.</paragraph>
                                    <paragraph>Use a negative number to stack VMs on one host instead of spreading
                                        out new VMs to more hosts in the cell.</paragraph>
                                </definition>
                            </definition_list_item>
                            <definition_list_item>
                                <term><literal>weight_offset</literal></term>
                                <definition>
                                    <paragraph>Allows modifying the database to weight a particular cell. You can use this
                                        when you want to disable a cell (for example, '0'), or to set a default
                                        cell by making its <literal>weight_offset</literal> very high (for example,
                                        <literal>999999999999999</literal>).  The highest weight will be the first cell to be
                                        scheduled for launching an instance.</paragraph>
                                </definition>
                            </definition_list_item>
                        </definition_list>
                    </definition>
                </definition_list_item>
            </definition_list>
            <paragraph>Additionally, the following options are available for the cell scheduler:</paragraph>
            <definition_list>
                <definition_list_item>
                    <term><literal>scheduler_retries</literal></term>
                    <definition>
                        <paragraph>Specifies how many times the scheduler tries to launch a new instance when no
                            cells are available (default=10).</paragraph>
                    </definition>
                </definition_list_item>
                <definition_list_item>
                    <term><literal>scheduler_retry_delay</literal></term>
                    <definition>
                        <paragraph>Specifies the delay (in seconds) between retries (default=2).</paragraph>
                    </definition>
                </definition_list_item>
            </definition_list>
            <paragraph>As an admin user, you can also add a filter that directs builds to a particular
                cell. The <literal>policy.json</literal> file must have a line with
                <literal>"cells_scheduler_filter:TargetCellFilter" : "is_admin:True"</literal> to let an admin
                user specify a scheduler hint to direct a build to a particular cell.</paragraph>
        </section>
        <section ids="optional-cell-configuration" names="optional\ cell\ configuration">
            <title>Optional cell configuration</title>
            <paragraph>Cells store all inter-cell communication data, including user names and
                passwords, in the database. Because the cells data is not updated very
                frequently, use the <literal>[cells]cells_config</literal> option to specify a JSON file to
                store cells data. With this configuration, the database is no longer consulted
                when reloading the cells data.  The file must have columns present in the Cell
                model (excluding common database fields and the <literal>id</literal> column). You must
                specify the queue connection information through a <literal>transport_url</literal> field,
                instead of <literal>username</literal>, <literal>password</literal>, and so on.</paragraph>
            <paragraph>The <literal>transport_url</literal> has the following form:</paragraph>
            <literal_block xml:space="preserve">rabbit://USERNAME:PASSWORD@HOSTNAME:PORT/VIRTUAL_HOST</literal_block>
            <paragraph>The scheme can only be <literal>rabbit</literal>.</paragraph>
            <paragraph>The following sample shows this optional configuration:</paragraph>
            <literal_block highlight_args="{}" language="json" linenos="False" xml:space="preserve">{
    "parent": {
        "name": "parent",
        "api_url": "http://api.example.com:8774",
        "transport_url": "rabbit://rabbit.example.com",
        "weight_offset": 0.0,
        "weight_scale": 1.0,
        "is_parent": true
    },
    "cell1": {
        "name": "cell1",
        "api_url": "http://api.example.com:8774",
        "transport_url": "rabbit://rabbit1.example.com",
        "weight_offset": 0.0,
        "weight_scale": 1.0,
        "is_parent": false
    },
    "cell2": {
        "name": "cell2",
        "api_url": "http://api.example.com:8774",
        "transport_url": "rabbit://rabbit2.example.com",
        "weight_offset": 0.0,
        "weight_scale": 1.0,
        "is_parent": false
    }
}</literal_block>
        </section>
    </section>
</document>
