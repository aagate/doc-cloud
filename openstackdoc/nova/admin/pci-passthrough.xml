<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/nova/doc/source/admin/pci-passthrough.rst">
    <section ids="attaching-physical-pci-devices-to-guests" names="attaching\ physical\ pci\ devices\ to\ guests">
        <title>Attaching physical PCI devices to guests</title>
        <paragraph>The PCI passthrough feature in OpenStack allows full access and direct control
            of a physical PCI device in guests. This mechanism is generic for any kind of
            PCI device, and runs with a Network Interface Card (NIC), Graphics Processing
            Unit (GPU), or any other devices that can be attached to a PCI bus. Correct
            driver installation is the only requirement for the guest to properly use the
            devices.</paragraph>
        <paragraph>Some PCI devices provide Single Root I/O Virtualization and Sharing (SR-IOV)
            capabilities. When SR-IOV is used, a physical device is virtualized and appears
            as multiple PCI devices. Virtual PCI devices are assigned to the same or
            different guests. In the case of PCI passthrough, the full physical device is
            assigned to only one guest and cannot be shared.</paragraph>
        <note>
            <paragraph>For information on attaching virtual SR-IOV devices to guests, refer to the
                <reference name="Networking Guide" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html">Networking Guide</reference>.</paragraph>
        </note>
        <paragraph>To enable PCI passthrough, follow the steps below:</paragraph>
        <enumerated_list enumtype="arabic" prefix="" suffix=".">
            <list_item>
                <paragraph>Configure nova-scheduler (Controller)</paragraph>
            </list_item>
            <list_item>
                <paragraph>Configure nova-api (Controller)**</paragraph>
            </list_item>
            <list_item>
                <paragraph>Configure a flavor (Controller)</paragraph>
            </list_item>
            <list_item>
                <paragraph>Enable PCI passthrough (Compute)</paragraph>
            </list_item>
            <list_item>
                <paragraph>Configure PCI devices in nova-compute (Compute)</paragraph>
            </list_item>
        </enumerated_list>
        <note>
            <paragraph>The PCI device with address <literal>0000:41:00.0</literal> is used as an example. This
                will differ between environments.</paragraph>
        </note>
        <section ids="configure-nova-scheduler-controller" names="configure\ nova-scheduler\ (controller)">
            <title>Configure nova-scheduler (Controller)</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Configure <literal>nova-scheduler</literal> as specified in <reference name="Configure nova-scheduler" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html#configure-nova-scheduler-controller">Configure nova-scheduler</reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Restart the <literal>nova-scheduler</literal> service.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="configure-nova-api-controller" names="configure\ nova-api\ (controller)">
            <title>Configure nova-api (Controller)</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Specify the PCI alias for the device.</paragraph>
                    <paragraph>Configure a PCI alias <literal>a1</literal> to request a PCI device with a <literal>vendor_id</literal> of
                        <literal>0x8086</literal> and a <literal>product_id</literal> of <literal>0x154d</literal>. The <literal>vendor_id</literal> and
                        <literal>product_id</literal> correspond the PCI device with address <literal>0000:41:00.0</literal>.</paragraph>
                    <paragraph>Edit <literal>/etc/nova/nova.conf</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[pci]
alias = { "vendor_id":"8086", "product_id":"154d", "device_type":"type-PF", "name":"a1" }</literal_block>
                    <paragraph>For more information about the syntax of <literal>alias</literal>, refer to
                        <reference internal="True" refuri="../configuration/config"><inline classes="doc">Configuration Options</inline></reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Restart the <literal>nova-api</literal> service.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="configure-a-flavor-controller" names="configure\ a\ flavor\ (controller)">
            <title>Configure a flavor (Controller)</title>
            <paragraph>Configure a flavor to request two PCI devices, each with <literal>vendor_id</literal> of
                <literal>0x8086</literal> and <literal>product_id</literal> of <literal>0x154d</literal>:</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># openstack flavor set m1.large --property "pci_passthrough:alias"="a1:2"</literal_block>
            <paragraph>For more information about the syntax for <literal>pci_passthrough:alias</literal>, refer to
                <reference internal="True" refuri="flavors"><inline classes="doc">Flavors</inline></reference>.</paragraph>
        </section>
        <section ids="enable-pci-passthrough-compute" names="enable\ pci\ passthrough\ (compute)">
            <title>Enable PCI passthrough (Compute)</title>
            <paragraph>Enable VT-d and IOMMU. For more information, refer to steps one and two in
                <reference name="Create Virtual Functions" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html#create-virtual-functions-compute">Create Virtual Functions</reference>.</paragraph>
        </section>
        <section ids="configure-pci-devices-compute" names="configure\ pci\ devices\ (compute)">
            <title>Configure PCI devices (Compute)</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Configure <literal>nova-compute</literal> to allow the PCI device to pass through to
                        VMs. Edit <literal>/etc/nova/nova.conf</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[pci]
passthrough_whitelist = { "address": "0000:41:00.0" }</literal_block>
                    <paragraph>Alternatively specify multiple PCI devices using whitelisting:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[pci]
passthrough_whitelist = { "vendor_id": "8086", "product_id": "10fb" }</literal_block>
                    <paragraph>All PCI devices matching the <literal>vendor_id</literal> and <literal>product_id</literal> are added to
                        the pool of PCI devices available for passthrough to VMs.</paragraph>
                    <paragraph>For more information about the syntax of <literal>passthrough_whitelist</literal>,
                        refer to <reference internal="True" refuri="../configuration/config"><inline classes="doc">Configuration Options</inline></reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Specify the PCI alias for the device.</paragraph>
                    <paragraph>From the Newton release, to resize guest with PCI device, configure the PCI
                        alias on the compute node as well.</paragraph>
                    <paragraph>Configure a PCI alias <literal>a1</literal> to request a PCI device with a <literal>vendor_id</literal> of
                        <literal>0x8086</literal> and a <literal>product_id</literal> of <literal>0x154d</literal>. The <literal>vendor_id</literal> and
                        <literal>product_id</literal> correspond the PCI device with address <literal>0000:41:00.0</literal>.</paragraph>
                    <paragraph>Edit <literal>/etc/nova/nova.conf</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="ini" linenos="False" xml:space="preserve">[pci]
alias = { "vendor_id":"8086", "product_id":"154d", "device_type":"type-PF", "name":"a1" }</literal_block>
                    <paragraph>For more information about the syntax of <literal>alias</literal>, refer to <reference internal="True" refuri="../configuration/config"><inline classes="doc">Configuration Options</inline></reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Restart the <literal>nova-compute</literal> service.</paragraph>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="create-instances-with-pci-passthrough-devices" names="create\ instances\ with\ pci\ passthrough\ devices">
            <title>Create instances with PCI passthrough devices</title>
            <paragraph>The <literal>nova-scheduler</literal> selects a destination host that has PCI devices
                available with the specified <literal>vendor_id</literal> and <literal>product_id</literal> that matches the
                <literal>alias</literal> from the flavor.</paragraph>
            <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># openstack server create --flavor m1.large --image cirros-0.3.5-x86_64-uec --wait test-pci</literal_block>
            <comment xml:space="preserve">Links</comment>
            <target ids="create-virtual-functions" names="create\ virtual\ functions" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html#create-virtual-functions-compute"></target>
            <target ids="configure-nova-scheduler" names="configure\ nova-scheduler" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html#configure-nova-scheduler-controller"></target>
            <target ids="networking-guide" names="networking\ guide" refuri="https://docs.openstack.org/neutron/latest/admin/config-sriov.html"></target>
        </section>
    </section>
</document>
