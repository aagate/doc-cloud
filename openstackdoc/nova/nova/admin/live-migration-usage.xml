<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.13.1 -->
<document source="/home/fbaumanis/openstack/soc8_test/openstack_repo/nova/doc/source/admin/live-migration-usage.rst">
    <section ids="live-migrate-instances" names="live-migrate\ instances">
        <title>Live-migrate instances</title>
        <paragraph>Live-migrating an instance means moving its virtual machine to a different
            OpenStack Compute server while the instance continues running.  Before starting
            a live-migration, review the chapter
            <reference internal="True" refuri="configuring-migrations#section-configuring-compute-migrations"><inline classes="std std-ref">Configure live migrations</inline></reference>. It covers the configuration
            settings required to enable live-migration, but also reasons for migrations and
            non-live-migration options.</paragraph>
        <paragraph>The instructions below cover shared-storage and volume-backed migration.  To
            block-migrate instances, add the command-line option
            <literal>-block-migrate</literal> to the <literal_strong classes="command">nova live-migration</literal_strong> command,
            and <literal>--block-migration</literal> to the <literal_strong classes="command">openstack server migrate</literal_strong>
            command.</paragraph>
        <target refid="section-manual-selection-of-dest"></target>
        <section ids="manual-selection-of-the-destination-host section-manual-selection-of-dest" names="manual\ selection\ of\ the\ destination\ host section-manual-selection-of-dest">
            <title>Manual selection of the destination host</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Obtain the ID of the instance you want to migrate:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack server list

+--------------------------------------+------+--------+-----------------+------------+
| ID                                   | Name | Status | Networks        | Image Name |
+--------------------------------------+------+--------+-----------------+------------+
| d1df1b5a-70c4-4fed-98b7-423362f2c47c | vm1  | ACTIVE | private=a.b.c.d | ...        |
| d693db9e-a7cf-45ef-a7c9-b3ecb5f22645 | vm2  | ACTIVE | private=e.f.g.h | ...        |
+--------------------------------------+------+--------+-----------------+------------+</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Determine on which host the instance is currently running. In this example,
                        <literal>vm1</literal> is running on <literal>HostB</literal>:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack server show d1df1b5a-70c4-4fed-98b7-423362f2c47c

+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| ...                  | ...                                  |
| OS-EXT-SRV-ATTR:host | HostB                                |
| ...                  | ...                                  |
| addresses            | a.b.c.d                              |
| flavor               | m1.tiny                              |
| id                   | d1df1b5a-70c4-4fed-98b7-423362f2c47c |
| name                 | vm1                                  |
| status               | ACTIVE                               |
| ...                  | ...                                  |
+----------------------+--------------------------------------+</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Select the compute node the instance will be migrated to. In this example,
                        we will migrate the instance to <literal>HostC</literal>, because <literal>nova-compute</literal> is
                        running on it:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack compute service list

+----+------------------+-------+----------+---------+-------+----------------------------+
| ID | Binary           | Host  | Zone     | Status  | State | Updated At                 |
+----+------------------+-------+----------+---------+-------+----------------------------+
|  3 | nova-conductor   | HostA | internal | enabled | up    | 2017-02-18T09:42:29.000000 |
|  4 | nova-scheduler   | HostA | internal | enabled | up    | 2017-02-18T09:42:26.000000 |
|  5 | nova-consoleauth | HostA | internal | enabled | up    | 2017-02-18T09:42:29.000000 |
|  6 | nova-compute     | HostB | nova     | enabled | up    | 2017-02-18T09:42:29.000000 |
|  7 | nova-compute     | HostC | nova     | enabled | up    | 2017-02-18T09:42:29.000000 |
+----+------------------+-------+----------+---------+-------+----------------------------+</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Check that <literal>HostC</literal> has enough resources for migration:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack host show HostC

+-------+------------+-----+-----------+---------+
| Host  | Project    | CPU | Memory MB | Disk GB |
+-------+------------+-----+-----------+---------+
| HostC | (total)    |  16 |     32232 |     878 |
| HostC | (used_now) |  22 |     21284 |     422 |
| HostC | (used_max) |  22 |     21284 |     422 |
| HostC | p1         |  22 |     21284 |     422 |
| HostC | p2         |  22 |     21284 |     422 |
+-------+------------+-----+-----------+---------+</literal_block>
                    <bullet_list bullet="-">
                        <list_item>
                            <paragraph><literal>cpu</literal>: Number of CPUs</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph><literal>memory_mb</literal>: Total amount of memory, in MB</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph><literal>disk_gb</literal>: Total amount of space for NOVA-INST-DIR/instances, in GB</paragraph>
                        </list_item>
                    </bullet_list>
                    <paragraph>In this table, the first row shows the total amount of resources available
                        on the physical server. The second line shows the currently used resources.
                        The third line shows the maximum used resources. The fourth line and below
                        shows the resources available for each project.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Migrate the instance:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack server migrate d1df1b5a-70c4-4fed-98b7-423362f2c47c --live HostC</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Confirm that the instance has been migrated successfully:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack server show d1df1b5a-70c4-4fed-98b7-423362f2c47c

+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| ...                  | ...                                  |
| OS-EXT-SRV-ATTR:host | HostC                                |
| ...                  | ...                                  |
+----------------------+--------------------------------------+</literal_block>
                    <paragraph>If the instance is still running on <literal>HostB</literal>, the migration failed. The
                        <literal>nova-scheduler</literal> and <literal>nova-conductor</literal> log files on the controller and
                        the <literal>nova-compute</literal> log file on the source compute host can help pin-point
                        the problem.</paragraph>
                </list_item>
            </enumerated_list>
            <target refid="auto-selection-of-dest"></target>
        </section>
        <section ids="automatic-selection-of-the-destination-host auto-selection-of-dest" names="automatic\ selection\ of\ the\ destination\ host auto_selection_of_dest">
            <title>Automatic selection of the destination host</title>
            <paragraph>To leave the selection of the destination host to the Compute service, use the
                nova command-line client.</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Obtain the instance ID as shown in step 1 of the section
                        <reference internal="True" refid="section-manual-selection-of-dest"><inline classes="std std-ref">Manual selection of the destination host</inline></reference>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Leave out the host selection steps 2, 3, and 4.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Migrate the instance:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ nova live-migration d1df1b5a-70c4-4fed-98b7-423362f2c47c</literal_block>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="monitoring-the-migration" names="monitoring\ the\ migration">
            <title>Monitoring the migration</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Confirm that the instance is migrating:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ openstack server show d1df1b5a-70c4-4fed-98b7-423362f2c47c

+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| ...                  | ...                                  |
| status               | MIGRATING                            |
| ...                  | ...                                  |
+----------------------+--------------------------------------+</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Check progress</paragraph>
                    <paragraph>Use the nova command-line client for nova's migration monitoring feature.
                        First, obtain the migration ID:</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ nova server-migration-list d1df1b5a-70c4-4fed-98b7-423362f2c47c
+----+-------------+-----------  (...)
| Id | Source Node | Dest Node | (...)
+----+-------------+-----------+ (...)
| 2  | -           | -         | (...)
+----+-------------+-----------+ (...)</literal_block>
                    <paragraph>For readability, most output columns were removed. Only the first column,
                        <strong>Id</strong>, is relevant.  In this example, the migration ID is 2. Use this to
                        get the migration status.</paragraph>
                    <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ nova server-migration-show d1df1b5a-70c4-4fed-98b7-423362f2c47c 2
+------------------------+--------------------------------------+
| Property               | Value                                |
+------------------------+--------------------------------------+
| created_at             | 2017-03-08T02:53:06.000000           |
| dest_compute           | controller                           |
| dest_host              | -                                    |
| dest_node              | -                                    |
| disk_processed_bytes   | 0                                    |
| disk_remaining_bytes   | 0                                    |
| disk_total_bytes       | 0                                    |
| id                     | 2                                    |
| memory_processed_bytes | 65502513                             |
| memory_remaining_bytes | 786427904                            |
| memory_total_bytes     | 1091379200                           |
| server_uuid            | d1df1b5a-70c4-4fed-98b7-423362f2c47c |
| source_compute         | compute2                             |
| source_node            | -                                    |
| status                 | running                              |
| updated_at             | 2017-03-08T02:53:47.000000           |
+------------------------+--------------------------------------+</literal_block>
                    <paragraph>The output shows that the migration is running. Progress is measured by the
                        number of memory bytes that remain to be copied. If this number is not
                        decreasing over time, the migration may be unable to complete, and it may be
                        aborted by the Compute service.</paragraph>
                    <note>
                        <paragraph>The command reports that no disk bytes are processed, even in the event
                            of block migration.</paragraph>
                    </note>
                </list_item>
            </enumerated_list>
        </section>
        <section ids="what-to-do-when-the-migration-times-out" names="what\ to\ do\ when\ the\ migration\ times\ out">
            <title>What to do when the migration times out</title>
            <paragraph>During the migration process, the instance may write to a memory page after
                that page has been copied to the destination. When that happens, the same page
                has to be copied again. The instance may write to memory pages faster than they
                can be copied, so that the migration cannot complete.  The Compute service will
                cancel it when the <literal>live_migration_completion_timeout</literal>, a configuration
                parameter, is reached.</paragraph>
            <paragraph>The following remarks assume the KVM/Libvirt hypervisor.</paragraph>
            <section ids="how-to-know-that-the-migration-timed-out" names="how\ to\ know\ that\ the\ migration\ timed\ out">
                <title>How to know that the migration timed out</title>
                <paragraph>To determine that the migration timed out, inspect the <literal>nova-compute</literal> log
                    file on the source host. The following log entry shows that the migration timed
                    out:</paragraph>
                <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve"># grep WARNING.*d1df1b5a-70c4-4fed-98b7-423362f2c47c /var/log/nova/nova-compute.log
...
WARNING nova.virt.libvirt.migration [req-...] [instance: ...]
live migration not completed after 1800 sec</literal_block>
                <paragraph>The Compute service also cancels migrations when the memory copy seems to make
                    no progress. Ocata disables this feature by default, but it can be enabled
                    using the configuration parameter <literal>live_migration_progress_timeout</literal>. Should
                    this be the case, you may find the following message in the log:</paragraph>
                <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">WARNING nova.virt.libvirt.migration [req-...] [instance: ...]
live migration stuck for 150 sec</literal_block>
            </section>
            <section ids="addressing-migration-timeouts" names="addressing\ migration\ timeouts">
                <title>Addressing migration timeouts</title>
                <paragraph>To stop the migration from putting load on infrastructure resources like
                    network and disks, you may opt to cancel it manually.</paragraph>
                <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ nova live-migration-abort INSTANCE_ID MIGRATION_ID</literal_block>
                <paragraph>To make live-migration succeed, you have several options:</paragraph>
                <bullet_list bullet="-">
                    <list_item>
                        <paragraph><strong>Manually force-complete the migration</strong></paragraph>
                        <literal_block highlight_args="{}" language="console" linenos="False" xml:space="preserve">$ nova live-migration-force-complete INSTANCE_ID MIGRATION_ID</literal_block>
                        <paragraph>The instance is paused until memory copy completes.</paragraph>
                        <caution>
                            <paragraph>Since the pause impacts time keeping on the instance and not all
                                applications tolerate incorrect time settings, use this approach with
                                caution.</paragraph>
                        </caution>
                    </list_item>
                    <list_item>
                        <paragraph><strong>Enable auto-convergence</strong></paragraph>
                        <paragraph>Auto-convergence is a Libvirt feature. Libvirt detects that the migration is
                            unlikely to complete and slows down its CPU until the memory copy process is
                            faster than the instance's memory writes.</paragraph>
                        <paragraph>To enable auto-convergence, set
                            <literal>live_migration_permit_auto_convergence=true</literal> in <literal>nova.conf</literal> and restart
                            <literal>nova-compute</literal>. Do this on all compute hosts.</paragraph>
                        <caution>
                            <paragraph>One possible downside of auto-convergence is the slowing down of the
                                instance.</paragraph>
                        </caution>
                    </list_item>
                    <list_item>
                        <paragraph><strong>Enable post-copy</strong></paragraph>
                        <paragraph>This is a Libvirt feature. Libvirt detects that the migration does not
                            progress and responds by activating the virtual machine on the destination
                            host before all its memory has been copied. Access to missing memory pages
                            result in page faults that are satisfied from the source host.</paragraph>
                        <paragraph>To enable post-copy, set <literal>live_migration_permit_post_copy=true</literal> in
                            <literal>nova.conf</literal> and restart <literal>nova-compute</literal>. Do this on all compute hosts.</paragraph>
                        <paragraph>When post-copy is enabled, manual force-completion does not pause the
                            instance but switches to the post-copy process.</paragraph>
                        <caution>
                            <paragraph>Possible downsides:</paragraph>
                            <bullet_list bullet="-">
                                <list_item>
                                    <paragraph>When the network connection between source and destination is
                                        interrupted, page faults cannot be resolved anymore, and the virtual
                                        machine is rebooted.</paragraph>
                                </list_item>
                                <list_item>
                                    <paragraph>Post-copy may lead to an increased page fault rate during migration,
                                        which can slow the instance down.</paragraph>
                                </list_item>
                            </bullet_list>
                        </caution>
                    </list_item>
                </bullet_list>
            </section>
        </section>
    </section>
</document>
